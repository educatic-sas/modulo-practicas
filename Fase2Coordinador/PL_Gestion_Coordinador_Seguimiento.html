<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gestión de Asignaciones – v8.0‑rc (Línea de diseño unificada)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --shadow-1:0 8px 24px rgba(0,0,0,.08); --shadow-2:0 12px 28px rgba(0,0,0,.12) }
    body{background:var(--bs-body-bg)}
    .app-header{position:sticky;top:0;z-index:1030;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color);box-shadow:0 4px 12px rgba(0,0,0,.04)}
    /* KPI */
    .kpi-card{position:relative;border:0;box-shadow:var(--shadow-1);transition:transform .25s ease,box-shadow .25s ease;cursor:pointer}
    .kpi-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-2)}
    .kpi-card::before{content:"";position:absolute;inset:0 auto 0 0;width:6px;border-radius:6px 0 0 6px;background:var(--bs-primary)}
    .kpi-meta{font-size:.8rem;opacity:.8}
    .legend-item{display:inline-flex;align-items:center;gap:.4rem;margin-right:1rem}
    .dot{width:.65rem;height:.65rem;border-radius:50%}
    .dot.green{background:#198754}.dot.amber{background:#ffc107}.dot.red{background:#dc3545}.dot.blue{background:#0d6efd}.dot.gray{background:#adb5bd}
    /* Toolbar */
    .sticky-toolbar{position:sticky;top:64px;z-index:10;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color)}
    /* Sidepanel */
    .sidepanel{position:fixed;top:0;right:-420px;width:420px;height:100vh;background:var(--bs-body-bg);box-shadow:-8px 0 24px rgba(0,0,0,.08);transition:right .3s ease;z-index:1055}
    .sidepanel.open{right:0}
    .sidepanel-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--bs-border-color)}
    .sidepanel-body{padding:1rem;overflow:auto;height:calc(100vh - 56px)}
    .badge-sla{font-weight:600}
    .table-actions .btn{--bs-btn-padding-y:.25rem;--bs-btn-padding-x:.5rem}
    .section-title{font-weight:700;font-size:.95rem;text-transform:uppercase;letter-spacing:.02em;color:var(--bs-secondary-color)}
    @media (max-width:576px){.sidepanel{width:100%}}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container-fluid py-2 d-flex align-items-center gap-2">
      <i class="bi bi-clipboard-data fs-4 text-primary" aria-hidden="true"></i>
      <div>
        <h1 class="h5 mb-0">Gestión de Asignaciones – Coordinación</h1>
        <div class="text-body-secondary small">Auditoría global • Monitoreo y escalamiento</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="darkModeSwitch"/>
          <label class="form-check-label" for="darkModeSwitch">Modo oscuro</label>
        </div>
      </div>
    </div>
  </header>

  <main class="container-fluid my-3">
    <!-- Guía de uso (colapsable con persistencia) -->
    <section class="mb-3" id="guideV8" aria-labelledby="guideV8Title">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-start gap-3">
            <i class="bi bi-compass fs-3 text-primary" aria-hidden="true"></i>
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-1">
                <h2 class="h6 mb-0" id="guideV8Title">Guía de uso – Gestión de Asignaciones (v8.0)</h2>
                <span class="badge text-bg-success" id="guideV8State" aria-hidden="true">Visible</span>
                <button id="btnHideGuideV8" class="btn btn-outline-secondary btn-sm ms-auto" type="button"
                        aria-controls="guideV8Body" aria-expanded="true" aria-label="Ocultar guía">
                  <i class="bi bi-eye-slash" aria-hidden="true"></i>
                  Ocultar guía
                </button>
              </div>
              <div id="guideV8Body" class="small">
                <ol class="mb-2 ps-3">
                  <li><strong>KPIs con drill‑down:</strong> clic en un KPI aplica filtro a la tabla.</li>
                  <li><strong>Presets y filtros:</strong> combina Facultad → Programa, Doc/NIT y tipo (Todas/Escenario/Autónoma).</li>
                  <li><strong>Alarmas:</strong> panel priorizado por severidad/antigüedad; desde el detalle puedes escalar o resolver.</li>
                  <li><strong>Detalle lateral:</strong> cronología (instalación/evaluaciones/alarmas), documentos y estado SLA.</li>
                  <li><strong>Exportes:</strong> XLSX/PDF (placeholders listos para conectar).</li>
                </ol>
                <div class="alert alert-info py-2 mb-0">Tip: guarda combinaciones de filtros frecuentes como presets.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
	
	
    <div id="guideV8Stub" class="alert alert-info d-none py-2 px-3 mb-2 d-flex align-items-center gap-2">
      <i class="bi bi-info-circle" aria-hidden="true"></i>
      <span class="small">Guía de uso oculta.</span>
      <button id="btnShowGuideV8" class="btn btn-link btn-sm ms-auto p-0" type="button">Ver guía</button>
    </div>

    <!-- Smart Header KPIs -->
    <section class="mb-3" aria-labelledby="smartHeaderTitle">
      <div class="d-flex align-items-center mb-2">
        <h2 class="h6 mb-0" id="smartHeaderTitle">Indicadores por bloques</h2>
        <div class="ms-auto small text-body-secondary">Clic en un KPI aplica filtro</div>
      </div>
      <div class="row g-3 row-cols-1 row-cols-md-3">
        <div class="col">
          <div class="card kpi-card" data-block="ejecucion">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-1">
                <i class="bi bi-play-circle text-success" aria-hidden="true"></i>
                <div class="fw-semibold">Ejecución</div>
              </div>
              <div class="d-flex align-items-center gap-4">
                <div>
                  <div class="display-6" id="kpiEjecucion">—</div>
                  <div class="kpi-meta">Estudiantes en ejecución</div>
                </div>
                <div class="flex-grow-1">
                  <div class="small mb-1">Instalación a tiempo</div>
                  <div class="progress" role="progressbar" aria-label="Cumplimiento instalación"><div class="progress-bar" id="barInst">0%</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card kpi-card" data-block="alarmas">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-1">
                <i class="bi bi-bell-fill text-danger" aria-hidden="true"></i>
                <div class="fw-semibold">Seguimiento y Alarmas</div>
              </div>
              <div class="d-flex align-items-center gap-4">
                <div>
                  <div class="display-6" id="kpiAlarmas">—</div>
                  <div class="kpi-meta">Alarmas abiertas</div>
                </div>
                <div class="flex-grow-1">
                  <div class="small mb-1">Atención en 72h</div>
                  <div class="progress" role="progressbar" aria-label="SLA alarmas"><div class="progress-bar bg-danger" id="barAlarmSLA">0%</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card kpi-card" data-block="evaluaciones">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-1">
                <i class="bi bi-clipboard2-check text-primary" aria-hidden="true"></i>
                <div class="fw-semibold">Evaluaciones</div>
              </div>
              <div class="d-flex align-items-center gap-4">
                <div>
                  <div class="display-6" id="kpiEvalPend">—</div>
                  <div class="kpi-meta">Pendientes (Parcial/Final)</div>
                </div>
                <div class="flex-grow-1">
                  <div class="small mb-1">Al día</div>
                  <div class="progress" role="progressbar" aria-label="Cumplimiento evaluaciones"><div class="progress-bar bg-success" id="barEval">0%</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-2 small">
        <span class="legend-item"><span class="dot green"></span> Normal</span>
        <span class="legend-item"><span class="dot amber"></span> Alerta Académica</span>
        <span class="legend-item"><span class="dot red"></span> Alerta Empresa</span>
        <span class="legend-item"><span class="dot blue"></span> Otros estados</span>
      </div>
    </section>

    <!-- Toolbar / filtros y exportes -->
    <section class="sticky-toolbar py-2 px-2 rounded-3 mb-3">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="btn-group btn-group-sm" role="group" aria-label="Presets guardados">
          <button class="btn btn-outline-secondary" data-preset="alarmas">Solo alarmas</button>
          <button class="btn btn-outline-secondary" data-preset="eval">Pendiente evaluación</button>
          <button class="btn btn-outline-secondary" data-preset="instalacion">Instalación fuera de fecha</button>
        </div>
        <div class="d-flex align-items-end gap-2 flex-wrap">
          <div>
            <label class="form-label" for="filFac">Facultad</label>
            <select id="filFac" class="form-select form-select-sm" style="min-width:16rem"><option value="">Todas</option></select>
          </div>
          <div>
            <label class="form-label" for="filProg">Programa</label>
            <select id="filProg" class="form-select form-select-sm" style="min-width:18rem" disabled><option value="">Todos</option></select>
          </div>
          <div>
            <label class="form-label" for="filDoc">Documento</label>
            <input id="filDoc" class="form-control form-control-sm" placeholder="CC/NIE"/>
          </div>
          <div>
            <label class="form-label" for="filNit">NIT</label>
            <input id="filNit" class="form-control form-control-sm" placeholder="NIT empresa"/>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClear"><i class="bi bi-eraser"></i> Limpiar</button>
            <button type="button" class="btn btn-primary btn-sm" id="btnSearch"><i class="bi bi-search"></i> Aplicar</button>
          </div>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" aria-label="Tipo">
            <input type="radio" class="btn-check" name="qTipo" id="qTipoAll" checked>
            <label class="btn btn-outline-secondary" for="qTipoAll">Todas</label>
            <input type="radio" class="btn-check" name="qTipo" id="qTipoEsc">
            <label class="btn btn-outline-secondary" for="qTipoEsc">Escenario</label>
            <input type="radio" class="btn-check" name="qTipo" id="qTipoAut">
            <label class="btn btn-outline-secondary" for="qTipoAut">Autónoma</label>
          </div>
          <select id="pageSize" class="form-select form-select-sm" style="width:auto">
            <option value="10">10</option>
            <option value="15" selected>15</option>
            <option value="25">25</option>
          </select>
          <button class="btn btn-outline-success btn-sm" id="btnExport"><i class="bi bi-download"></i> XLSX</button>
          <button class="btn btn-outline-dark btn-sm" id="btnPDF"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
        </div>
      </div>
    </section>

    <div class="row g-3">
      <!-- Panel de Alarmas -->
      <div class="col-12 col-lg-4">
        <div class="card h-100" aria-labelledby="alarmPanelTitle">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-exclamation-triangle text-danger" aria-hidden="true"></i>
            <div class="fw-semibold" id="alarmPanelTitle">Alarmas (prioridad por antigüedad)</div>
            <div class="ms-auto small"><span class="badge text-bg-danger" id="badgeCrit">0 críticas</span></div>
          </div>
          <div class="list-group list-group-flush" id="alarmList" role="list"></div>
          <div class="card-footer d-flex align-items-center gap-2">
            <button class="btn btn-outline-primary btn-sm" id="btnEscalar"><i class="bi bi-arrow-up-right-circle"></i> Escalar</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnResolver"><i class="bi bi-check2-circle"></i> Marcar resueltas</button>
          </div>
        </div>
      </div>

      <!-- Tabla principal -->
      <div class="col-12 col-lg-8">
        <div class="card">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-table" aria-hidden="true"></i>
            <div class="fw-semibold">Estudiantes (<span id="countLabel">—</span>)</div>
            <div id="pageLabel" class="ms-auto small">Página 1</div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Estudiante</th>
                  <th class="text-nowrap">Documento</th>
                  <th>Empresa / Tipo / Dependencia / Tutor / Horario</th>
                  <th>Estado</th>
                  <th class="text-end">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="card-footer d-flex align-items-center gap-2">
            <div class="btn-group" role="group" aria-label="Paginación">
              <button class="btn btn-outline-secondary btn-sm" id="btnPrev"><i class="bi bi-chevron-left"></i></button>
              <span class="btn btn-light btn-sm disabled" id="pageLabelBottom">Página 1</span>
              <button class="btn btn-outline-secondary btn-sm" id="btnNext"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sidepanel Detalle -->
  <aside class="sidepanel" id="sidepanel" aria-labelledby="sideTitle" aria-modal="true" role="dialog">
    <div class="sidepanel-header">
      <div class="fw-semibold" id="sideTitle">Detalle</div>
      <button class="btn btn-sm btn-light" id="btnCloseSide"><i class="bi bi-x"></i></button>
    </div>
    <div class="sidepanel-body">
      <div class="section-title mb-2">Estudiante</div>
      <div id="sideStudent">—</div>
      <hr/>
      <div class="section-title mb-2">Cronología</div>
      <ul class="list-group mb-3" id="sideTimeline"></ul>
      <div class="section-title mb-2">Documentos</div>
      <div id="sideDocs" class="d-flex flex-column gap-2"></div>
      <hr/>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-warning text-dark badge-sla" id="sideSLA">SLA</span>
        <button class="btn btn-outline-danger btn-sm" id="btnEscalarSide"><i class="bi bi-arrow-up-right"></i> Escalar</button>
        <button class="btn btn-outline-success btn-sm" id="btnResolverSide"><i class="bi bi-check2"></i> Resolver</button>
      </div>
    </div>
  </aside>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex"><div class="toast-body" id="toastMsg">Hecho</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===================== Utils =====================
    const toastEl=document.getElementById('toast');
    const toastMsg=document.getElementById('toastMsg');
    const toast=new bootstrap.Toast(toastEl);
    const showToast=(m,v='primary')=>{toastEl.className='toast align-items-center text-bg-'+v+' border-0';toastMsg.textContent=m;toast.show();};
    const paginate=(arr,page,size)=>{const st=(page-1)*size;return arr.slice(st,st+size)};
    const fmt=(d)=> new Date(d).toLocaleDateString('es-CO');

    // ===================== Demo Data =====================
    const FACULTADES={ 'Ingeniería':['Ingeniería de Sistemas','Ingeniería Industrial','Ingeniería Civil'], 'Salud':['Enfermería','Fisioterapia'], 'Ciencias Económicas':['Administración de Empresas','Contaduría'], 'Educación':['Lic. Matemáticas','Lic. Lengua'] };
    const EMPRESAS=Array.from({length:24},(_,i)=>({nombre:`Empresa ${i+1}`, nit:`90${(1000000+i)}`, dependencia:['Operaciones','TI','Talento','Finanzas'][i%4], tutor:['Laura','Carlos','Marta','Andrés'][i%4], horario:['Mañana','Tarde','Noche'][i%3]}));
    const ESTADOS=['En solicitud','En Proceso de Legalización','Concertación de la práctica','Ejecución de la práctica','Finalizada'];
    const TIPOS=['Escenario','Autónoma'];
    function rand(a){return a[Math.floor(Math.random()*a.length)]} function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min} function dateStr(y,m,d){const mm=String(m).padStart(2,'0');const dd=String(d).padStart(2,'0');return `${y}-${mm}-${dd}`}
    const STUDENTS=(()=>{const arr=[];let idx=1;while(arr.length<160){const fac=rand(Object.keys(FACULTADES));const prog=rand(FACULTADES[fac]);const emp=rand(EMPRESAS);const estado=rand(ESTADOS);const tipo=rand(TIPOS);const start=dateStr(2025,randInt(1,6),randInt(1,28));const end=dateStr(2025,randInt(7,12),randInt(1,28));const onTime=Math.random()>.7;const evalParcial=Math.random()>.5;const evalFinal=(estado==='Finalizada')?true:Math.random()>.4;const alarmas=randInt(0,3);arr.push({id:`S-${idx.toString().padStart(4,'0')}`,doc:(10000000+idx).toString(),nombre:`Estudiante ${idx}`,apellidos:['García','López','Rodríguez','Martínez','Pérez'][idx%5],facultad:fac,programa:prog,tipo,empresa:emp,fechas:{inicio:start,fin:end},estado,docente:['Doc. Alvarez','Doc. Ramírez','Doc. Medina','Doc. Ríos'][idx%4],grupo:['A1','A2','B1','B2','C1','C2'][idx%6],plan:{url:`#plan_${idx}.pdf`},instalacion:{onTime,fecha:start,url:`#inst_${idx}.pdf`},seguimiento:{url:`#seg_${idx}.html`},evalParcial:{done:evalParcial,url:`#eval_${idx}.html`},evalFinal:{done:evalFinal,url:`#final_${idx}.html`},alarmas:{abiertas:alarmas,url:`#alarm_${idx}.html`}});idx++;}return arr})();

    // ===================== Estado UI =====================
    let filters={fac:'',prog:'',doc:'',nit:'',tipo:'' ,preset:''};
    let page=1; let pageSize=15;

    const isExec=s=> s.estado==='Ejecución de la práctica';
    const isAcadAlert=s=> isExec(s) && (!s.instalacion.onTime || !s.evalParcial.done || !s.evalFinal.done);
    const isEmpAlert=s=> (s.alarmas?.abiertas||0)>0;
    const stateColor=s=> isEmpAlert(s)?'red':(isAcadAlert(s)?'amber':'green');

    function dataset(){
      return STUDENTS.filter(s=>
        (!filters.fac || s.facultad===filters.fac) &&
        (!filters.prog || s.programa===filters.prog) &&
        (!filters.doc || s.doc.includes(filters.doc)) &&
        (!filters.nit || (s.empresa.nit||'').includes(filters.nit)) &&
        (!filters.tipo || s.tipo===filters.tipo) &&
        (!filters.preset || (filters.preset==='alarmas'? isEmpAlert(s) : (filters.preset==='eval'? (!s.evalParcial.done||!s.evalFinal.done) : (filters.preset==='instalacion'? !s.instalacion.onTime : true))))
      );
    }

    // ===================== KPIs =====================
    function refreshKPIs(){
      const data=dataset();
      const ejec=data.filter(isExec).length;
      const instOk=data.length? Math.round(data.filter(s=>s.instalacion.onTime).length*100/data.length):0;
      const alarms=data.reduce((a,s)=>a+(s.alarmas?.abiertas||0),0);
      const alarmSLA=data.length? Math.round((data.filter(s=> isEmpAlert(s) && Math.random()>.4).length)*100/Math.max(1,data.filter(isEmpAlert).length||1)) : 0; // demo
      const evalPend=data.filter(s=> !s.evalParcial.done || !s.evalFinal.done).length;
      const evalOK=data.length? Math.round((data.length-evalPend)*100/data.length):0;
      document.getElementById('kpiEjecucion').textContent=ejec;
      document.getElementById('kpiAlarmas').textContent=alarms;
      document.getElementById('kpiEvalPend').textContent=evalPend;
      const b1=document.getElementById('barInst'); b1.style.width=instOk+'%'; b1.textContent=instOk+'%';
      const b2=document.getElementById('barAlarmSLA'); b2.style.width=alarmSLA+'%'; b2.textContent=alarmSLA+'%';
      const b3=document.getElementById('barEval'); b3.style.width=evalOK+'%'; b3.textContent=evalOK+'%';
      document.getElementById('countLabel').textContent=data.length;
    }

    // ===================== Alarmas panel =====================
    function renderAlarms(){
      const list=document.getElementById('alarmList'); list.innerHTML='';
      const data=dataset().filter(isEmpAlert).sort((a,b)=> b.alarmas.abiertas-a.alarmas.abiertas).slice(0,15);
      document.getElementById('badgeCrit').textContent=`${data.filter(s=>s.alarmas.abiertas>=2).length} críticas`;
      data.forEach(s=>{
        const item=document.createElement('button');
        item.className='list-group-item list-group-item-action d-flex align-items-center gap-2';
        item.innerHTML=`<span class="badge text-bg-${s.alarmas.abiertas>=2?'danger':'warning'}">${s.alarmas.abiertas}</span>
          <div class="text-start">
            <div class="fw-semibold">${s.nombre} ${s.apellidos}</div>
            <div class="small text-body-secondary">${s.programa} • ${s.empresa.nombre} • Inicio ${fmt(s.fechas.inicio)}</div>
          </div>`;
        item.addEventListener('click', ()=> openSidepanel(s));
        list.appendChild(item);
      });
    }

    // ===================== Tabla =====================
    function renderTable(){
      const data=dataset();
      const totalPages=Math.max(1,Math.ceil(data.length/pageSize));
      if(page>totalPages) page=totalPages;
      const pageData=paginate(data,page,pageSize);
      const label=`Página ${page} de ${totalPages}`; document.getElementById('pageLabel').textContent=label; document.getElementById('pageLabelBottom').textContent=label;
      const tbody=document.getElementById('tbody'); tbody.innerHTML='';
      pageData.forEach((s)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>
            <div class="d-flex align-items-start gap-2">
              <span class="dot ${stateColor(s)}" title="semáforo"></span>
              <div>
                <div class="fw-semibold">${s.nombre} ${s.apellidos} ${badgeForState(s)}</div>
                <div class="small text-body-secondary">${s.programa}</div>
              </div>
            </div>
          </td>
          <td class="text-nowrap">${s.doc}</td>
          <td>
            <div class="fw-semibold">${s.empresa.nombre}</div>
            <div class="small text-body-secondary">${s.tipo} • ${s.empresa.dependencia} • Tutor: ${s.empresa.tutor} • ${s.empresa.horario}</div>
          </td>
          <td>
            <span class="badge ${isEmpAlert(s)?'text-bg-danger':(isAcadAlert(s)?'text-bg-warning':'text-bg-success')}">${isEmpAlert(s)?'Alerta Empresa':(isAcadAlert(s)?'Alerta Académica':'Normal')}</span>
          </td>
          <td class="text-end table-actions">
            <button class="btn btn-outline-secondary btn-sm" data-action="detalle"><i class="bi bi-eye"></i></button>
            <button class="btn btn-outline-danger btn-sm" data-action="escalar"><i class="bi bi-arrow-up-right"></i></button>
          </td>`;
        tr.querySelector('[data-action="detalle"]').addEventListener('click', ()=> openSidepanel(s));
        tr.querySelector('[data-action="escalar"]').addEventListener('click', ()=> { showToast('Solicitud de escalamiento enviada','danger'); });
        tbody.appendChild(tr);
      });
      document.getElementById('btnPrev').disabled=page<=1;
      document.getElementById('btnNext').disabled=page>=totalPages;
    }

    // ===================== Badge estado =====================
    function badgeForState(s){
      const exec=isExec(s);
      if(exec){
        if(isEmpAlert(s)) return '<span class="badge text-bg-danger ms-1">Ejecución – Alerta Empresa</span>';
        if(isAcadAlert(s)) return '<span class="badge text-bg-warning ms-1">Ejecución – Alerta Académica</span>';
        return '<span class="badge text-bg-success ms-1">Ejecución – Normal</span>';
      }
      const map={ 'En solicitud':'secondary','En Proceso de Legalización':'secondary','Concertación de la práctica':'warning','Finalizada':'primary' };
      const bb=map[s.estado]||'light';
      return `<span class="badge text-bg-${bb} ms-1">${s.estado}</span>`;
    }

    // ===================== Sidepanel =====================
    const side=document.getElementById('sidepanel');
    document.getElementById('btnCloseSide').addEventListener('click', ()=> side.classList.remove('open'));
    function openSidepanel(s){
      document.getElementById('sideTitle').textContent=`${s.nombre} ${s.apellidos}`;
      document.getElementById('sideStudent').innerHTML=`
        <div class="mb-1"><b>Prog.:</b> ${s.programa} • <b>Fac.:</b> ${s.facultad}</div>
        <div><b>Empresa:</b> ${s.empresa.nombre} (${s.tipo}) • <b>Periodo:</b> ${fmt(s.fechas.inicio)} → ${fmt(s.fechas.fin)}</div>`;
      const tl=document.getElementById('sideTimeline'); tl.innerHTML='';
      const pasos=[
        {k:'Instalación',v: s.instalacion.onTime? 'A tiempo' : 'Fuera de fecha'},
        {k:'Evaluación parcial', v: s.evalParcial.done? 'Completada':'Pendiente'},
        {k:'Evaluación final', v: s.evalFinal.done? 'Completada':'Pendiente'},
        {k:'Alarmas', v: s.alarmas.abiertas}
      ];
      pasos.forEach(p=>{ const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between'; li.innerHTML=`<span>${p.k}</span><span class="badge ${p.v==='Fuera de fecha' || p.v==='Pendiente' || (typeof p.v==='number' && p.v>0)?'text-bg-danger':'text-bg-success'}">${p.v}</span>`; tl.appendChild(li); });
      const docs=document.getElementById('sideDocs'); docs.innerHTML='';
      ['Plan','Instalación','Seguimiento','Evaluación parcial','Evaluación final','Alarmas'].forEach(d=>{ const a=document.createElement('a'); a.href='#'; a.className='btn btn-outline-secondary btn-sm'; a.textContent=d; docs.appendChild(a); });
      const sla = isEmpAlert(s)? 'Crítica (empresa)': (isAcadAlert(s)? 'Académica' : 'Normal');
      const badge=document.getElementById('sideSLA'); badge.textContent = `SLA: ${sla}`; badge.className='badge badge-sla '+(isEmpAlert(s)?'text-bg-danger':(isAcadAlert(s)?'text-bg-warning text-dark':'text-bg-success'));
      document.getElementById('btnEscalarSide').onclick=()=> showToast('Escalado a Decano','danger');
      document.getElementById('btnResolverSide').onclick=()=> showToast('Marcado como resuelto','success');
      side.classList.add('open');
    }

    // ===================== Filtros y presets =====================
    function wireFacProg(){
      const $fac=document.getElementById('filFac'); const $prog=document.getElementById('filProg');
      Object.keys(FACULTADES).forEach(f=>{const o=document.createElement('option');o.value=f;o.textContent=f;$fac.appendChild(o)});
      $fac.addEventListener('change',e=>{filters.fac=e.target.value; const arr=FACULTADES[filters.fac]||[]; $prog.innerHTML='<option value="">Todos</option>'; if(arr.length){arr.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;$prog.appendChild(o)}); $prog.disabled=false;} else {$prog.disabled=true; filters.prog='';}});
      $prog.addEventListener('change',e=> filters.prog=e.target.value);
    }
    function applyFilters(){ page=1; refreshKPIs(); renderAlarms(); renderTable(); }
    function clearFilters(){ filters={fac:'',prog:'',doc:'',nit:'',tipo:'',preset:''}; document.getElementById('filProg').disabled=true; document.getElementById('filDoc').value=''; document.getElementById('filNit').value=''; document.getElementById('filFac').value=''; document.getElementById('filProg').value=''; document.getElementById('qTipoAll').checked=true; applyFilters(); }

    // ===================== Export (placeholders) =====================
    function exportXLSX(){ showToast('Exportación XLSX (integrar SheetJS / servidor)','primary'); }
    function exportPDF(){ showToast('Exportación PDF (integrar servidor)','primary'); }

    // ===================== Dark mode =====================
    document.getElementById('darkModeSwitch').addEventListener('change', (e)=>{ document.documentElement.setAttribute('data-bs-theme', e.target.checked? 'dark':'light'); });

    // ===================== Init =====================
    function init(){
      wireFacProg();
      document.getElementById('filDoc').addEventListener('input', e=> filters.doc=e.target.value.trim());
      document.getElementById('filNit').addEventListener('input', e=> filters.nit=e.target.value.trim());
      document.getElementById('btnSearch').addEventListener('click', applyFilters);
      document.getElementById('btnClear').addEventListener('click', clearFilters);
      document.querySelectorAll('[data-preset]').forEach(b=> b.addEventListener('click', (e)=>{ filters.preset=e.currentTarget.dataset.preset; applyFilters(); showToast('Preset aplicado: '+filters.preset,'secondary'); }));
      document.getElementById('qTipoAll').addEventListener('change', ()=>{ filters.tipo=''; applyFilters(); });
      document.getElementById('qTipoEsc').addEventListener('change', ()=>{ filters.tipo='Escenario'; applyFilters(); });
      document.getElementById('qTipoAut').addEventListener('change', ()=>{ filters.tipo='Autónoma'; applyFilters(); });
      document.getElementById('btnPrev').addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      document.getElementById('btnNext').addEventListener('click', ()=>{ const totalPages=Math.max(1,Math.ceil(dataset().length/pageSize)); if(page<totalPages){ page++; renderTable(); }});
      document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize=+e.target.value; page=1; renderTable(); });
      document.getElementById('btnExport').addEventListener('click', exportXLSX);
      document.getElementById('btnPDF').addEventListener('click', exportPDF);
      document.querySelector('[data-block="ejecucion"]').addEventListener('click', ()=>{ filters.preset=''; filters.tipo=''; applyFilters(); showToast('Drill-down: Estudiantes en ejecución','primary'); });
      document.querySelector('[data-block="alarmas"]').addEventListener('click', ()=>{ filters.preset='alarmas'; applyFilters(); });
      document.querySelector('[data-block="evaluaciones"]').addEventListener('click', ()=>{ filters.preset='eval'; applyFilters(); });
      applyFilters();
    }
    init();

    // ===================== Guía persistencia =====================
    (function(){
      const KEY='pl.gestion.v8.guide.hidden';
      const sec=document.getElementById('guideV8'); const badge=document.getElementById('guideV8State');
      const btnHide=document.getElementById('btnHideGuideV8'); const stub=document.getElementById('guideV8Stub'); const btnShow=document.getElementById('btnShowGuideV8');
      function apply(){ const hidden=localStorage.getItem(KEY)==='1'; if(hidden){ sec?.classList.add('d-none'); stub?.classList.remove('d-none'); btnHide?.setAttribute('aria-expanded','false'); btnHide?.setAttribute('aria-label','Ver guía'); if(badge){ badge.textContent='Oculta'; badge.className='badge text-bg-secondary'; } } else { sec?.classList.remove('d-none'); stub?.classList.add('d-none'); btnHide?.setAttribute('aria-expanded','true'); btnHide?.setAttribute('aria-label','Ocultar guía'); if(badge){ badge.textContent='Visible'; badge.className='badge text-bg-success'; } } }
      btnHide?.addEventListener('click', ()=>{ const hidden=localStorage.getItem(KEY)==='1'; localStorage.setItem(KEY, hidden?'0':'1'); apply(); if(localStorage.getItem(KEY)==='1'){ btnShow?.focus(); } else { btnHide?.focus(); } });
      btnShow?.addEventListener('click', ()=>{ localStorage.setItem(KEY,'0'); apply(); btnHide?.focus(); });
      apply();
    })();
  </script>
</body>
</html>