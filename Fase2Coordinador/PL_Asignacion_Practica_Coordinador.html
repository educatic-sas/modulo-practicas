<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Asignación de Prácticas — Coordinación (v3.4.1 Fix visor + KPIs)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --shadow-1:0 8px 24px rgba(0,0,0,.08); --shadow-2:0 12px 28px rgba(0,0,0,.12) }
    body{background:var(--bs-body-bg)}
    .app-header{position:sticky;top:0;z-index:1030;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color);box-shadow:0 4px 12px rgba(0,0,0,.04)}
    .sticky-toolbar{position:sticky;top:64px;z-index:10;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color)}
    .card-elev{border:0;box-shadow:var(--shadow-1)} .card-elev:hover{box-shadow:var(--shadow-2)}
    .kpi{font-weight:800;font-size:1.4rem}
    .list-tools{padding:.5rem;border-bottom:1px solid var(--bs-border-color);background:var(--bs-tertiary-bg)}
    .small-muted{font-size:.825rem;color:var(--bs-secondary-color)}
    .sidepanel{position:fixed;top:0;right:-520px;width:520px;height:100vh;background:var(--bs-body-bg);box-shadow:-8px 0 24px rgba(0,0,0,.08);transition:right .3s ease;z-index:1055}
    .sidepanel.open{right:0}
    .sidepanel-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--bs-border-color)}
    .sidepanel-body{padding:1rem;overflow:auto;height:calc(100vh - 56px)}
    .toast-lite{position:fixed;right:1rem;bottom:1rem;z-index:2000;min-width:260px;border-radius:.5rem;box-shadow:0 8px 20px rgba(0,0,0,.15);padding:.75rem 1rem;color:#fff;display:none}
    .toast-lite.show{display:block}
    .toast-lite.primary{background:#0d6efd}.toast-lite.success{background:#198754}.toast-lite.danger{background:#dc3545}.toast-lite.secondary{background:#6c757d}
    .mini-table th,.mini-table td{font-size:.85rem; vertical-align:middle}
    .modal-lite{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2005}
    .modal-lite.show{display:flex}
    .modal-card{width:min(1000px,95vw);height:min(80vh,95vh);background:var(--bs-body-bg);border-radius:.75rem;box-shadow:var(--shadow-2);display:flex;flex-direction:column;overflow:hidden}
    .modal-head{padding:.5rem .75rem;border-bottom:1px solid var(--bs-border-color);display:flex;align-items:center;gap:.5rem}
    .modal-body{flex:1;overflow:hidden}
    .modal-body iframe{width:100%;height:100%;border:0}
    .status-badge{font-size:.75rem}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container-fluid py-2 d-flex align-items-center gap-2">
      <i class="bi bi-diagram-3 fs-4 text-primary"></i>
      <div>
        <h1 class="h5 mb-0">Asignación de Prácticas — Coordinación (v3.4.1)</h1>
        <div class="text-body-secondary small">Fix: visor estable y KPIs persistentes</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="darkModeSwitch"/>
          <label class="form-check-label" for="darkModeSwitch">Modo oscuro</label>
        </div>
      </div>
    </div>
  </header>

  <main class="container-fluid my-3">
    <section class="mb-3">
      <div class="row g-3 row-cols-1 row-cols-md-5">
        <div class="col"><div class="card card-elev"><div class="card-body d-flex align-items-center gap-3"><i class="bi bi-person-gear fs-3 text-primary"></i><div><div class="kpi" id="kpiPend">0</div><div class="text-body-secondary">Sin práctica</div></div></div></div></div>
        <div class="col"><div class="card card-elev"><div class="card-body d-flex align-items-center gap-3"><i class="bi bi-building fs-3 text-success"></i><div><div class="kpi" id="kpiOfertas">0</div><div class="text-body-secondary">Ofertas disponibles</div></div></div></div></div>
        <div class="col"><div class="card card-elev"><div class="card-body d-flex align-items-center gap-3"><i class="bi bi-check2-circle fs-3 text-info"></i><div><div class="kpi" id="kpiAsignadas">0</div><div class="text-body-secondary">Asignaciones hoy</div></div></div></div></div>
        <div class="col"><div class="card card-elev"><div class="card-body d-flex align-items-center gap-3"><i class="bi bi-ui-checks fs-3 text-warning"></i><div><div class="kpi" id="kpiSel">0</div><div class="text-body-secondary">Seleccionados</div></div></div></div></div>
        <div class="col">
          <div class="card card-elev">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div class="text-body-secondary small">PT: Pend/Aut/Rec</div>
                <div class="d-flex gap-2">
                  <span class="badge text-bg-secondary" id="kpiPTPend">0</span>
                  <span class="badge text-bg-success" id="kpiPTAut">0</span>
                  <span class="badge text-bg-danger" id="kpiPTRec">0</span>
                </div>
              </div>
              <div class="small-muted mt-1">Entre seleccionados con “Practicante trabajador”.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="sticky-toolbar py-2 px-2 rounded-3 mb-3">
      <div class="d-flex align-items-end gap-2 flex-wrap">
        <div><label class="form-label" for="filFac">Facultad</label><select id="filFac" class="form-select form-select-sm" style="min-width:16rem"><option value="">Todas</option></select></div>
        <div><label class="form-label" for="filProg">Programa</label><select id="filProg" class="form-select form-select-sm" style="min-width:18rem" disabled><option value="">Todos</option></select></div>
        <div><label class="form-label" for="filModalidad">Modalidad</label><select id="filModalidad" class="form-select form-select-sm" style="width:auto"><option value="">Todas</option><option>Escenario</option><option>Autónoma</option></select></div>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="btnClear"><i class="bi bi-eraser"></i> Limpiar</button>
          <button class="btn btn-primary btn-sm" id="btnSearch"><i class="bi bi-search"></i> Aplicar</button>
        </div>
      </div>
    </section>

    <div class="row g-3">
      <div class="col-12 col-lg-5">
        <div class="card card-elev h-100">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-person-lines-fill"></i><div class="fw-semibold">Estudiantes sin práctica</div>
            <span class="ms-auto badge text-bg-secondary" id="lblEstCount">0</span>
          </div>
          <div class="list-tools d-flex align-items-center gap-2">
            <input id="searchEst" class="form-control form-control-sm" placeholder="Buscar por nombre o documento…"/>
            <div class="form-check ms-auto">
              <input class="form-check-input" type="checkbox" id="checkAll"/>
              <label class="form-check-label small" for="checkAll">Seleccionar todos</label>
            </div>
          </div>
          <div class="list-group list-group-flush" id="estList" role="list"></div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card card-elev h-100">
          <div class="card-header d-flex align-items-center gap-2">
            <i class="bi bi-buildings"></i><div class="fw-semibold">Ofertas / Escenarios</div>
            <span class="ms-auto badge text-bg-secondary" id="lblOffCount">0</span>
          </div>
          <div class="list-tools d-flex align-items-center gap-2 flex-wrap">
            <input id="searchOff" class="form-control form-control-sm" placeholder="Buscar empresa, dependencia, tutor…"/>
            <select id="filHorario" class="form-select form-select-sm" style="width:auto"><option value="">Horario: Todos</option><option>Mañana</option><option>Tarde</option><option>Noche</option></select>
            <select id="filMod" class="form-select form-select-sm" style="width:auto"><option value="">Modalidad: Todas</option><option>Presencial</option><option>Mixta</option><option>Remota</option></select>
          </div>
          <div class="list-group list-group-flush" id="offList" role="list"></div>
          <div class="p-2 small-muted">La oferta se aplica a estudiantes con <b>Modalidad: Escenario</b> (no “Practicante trabajador”).</div>
        </div>
      </div>

      <div class="col-12 col-lg-3">
        <div class="card card-elev h-100">
          <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-magic"></i><div class="fw-semibold">Asignación</div></div>
          <div class="card-body">
            <div class="small text-body-secondary mb-2">Para “Practicante trabajador” el estudiante ya subió carta y registró empresa/tutor. Visualiza y <b>autoriza/rechaza</b>.</div>
            <div class="d-grid gap-2 p-2 border rounded-3 mb-3" style="background:var(--bs-tertiary-bg)">
              <div class="d-flex gap-2 align-items-end flex-wrap">
                <div><label class="form-label small mb-1">Modalidad</label><select id="bulkMod" class="form-select form-select-sm"><option>Escenario</option><option>Autónoma</option></select></div>
                <div><label class="form-label small mb-1">Tipo</label><select id="bulkTipo" class="form-select form-select-sm"></select></div>
                <button id="btnApplyBulk" class="btn btn-sm btn-outline-primary ms-auto"><i class="bi bi-arrow-down-square"></i> Aplicar a seleccionados</button>
              </div>
              <div class="small-muted">En <b>Practicante trabajador</b> no hay botón de carga: la carta se abre con <i>Ver carta</i>.</div>
            </div>

            <div class="table-responsive">
              <table class="table mini-table">
                <thead><tr><th>Estudiante</th><th>Modalidad</th><th>Tipo</th></tr></thead>
                <tbody id="selTable"><tr><td colspan="3" class="text-center small text-body-secondary">Selecciona estudiantes…</td></tr></tbody>
              </table>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" id="btnAsignar" disabled><i class="bi bi-check2-circle"></i> Asignar práctica(s)</button>
              <button class="btn btn-outline-dark" id="btnActa" disabled><i class="bi bi-filetype-pdf"></i> Generar acta (PDF)</button>
            </div>
            <hr/>
            <div class="small-muted mb-1">Historial (sesión):</div>
            <ol id="log" class="small m-0"></ol>
          </div>
        </div>
      </div>
    </div>
  </main>

  <aside class="sidepanel" id="side" aria-modal="true" role="dialog">
    <div class="sidepanel-header"><div class="fw-semibold" id="sideTitle">Oferta</div><button class="btn btn-sm btn-light" id="btnCloseSide"><i class="bi bi-x"></i></button></div>
    <div class="sidepanel-body"><div id="sideBody">—</div><hr/><div class="d-flex align-items-center gap-2"><button class="btn btn-outline-primary btn-sm" id="btnUseOffer"><i class="bi bi-check2"></i> Usar esta oferta</button></div></div>
  </aside>

  <div class="modal-lite" id="modalCarta" aria-modal="true" role="dialog">
    <div class="modal-card">
      <div class="modal-head">
        <i class="bi bi-file-earmark-text"></i>
        <div class="fw-semibold" id="modalCartaTitle">Carta</div>
        <button class="btn btn-sm btn-light ms-auto" id="btnCloseCarta"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="modal-body">
        <iframe id="iframeCarta" title="Carta del estudiante"></iframe>
      </div>
    </div>
  </div>

  <div class="toast-lite" id="xtoast">Hecho</div>

  <script>
    const xtoast = document.getElementById('xtoast');
    function toast(msg, kind='primary'){ xtoast.textContent=msg; xtoast.className='toast-lite show '+kind; setTimeout(()=>{ xtoast.className='toast-lite '+kind; xtoast.style.display='none'; }, 1800); xtoast.style.display='block'; }
    document.getElementById('darkModeSwitch').addEventListener('change', (e)=>{ document.documentElement.setAttribute('data-bs-theme', e.target.checked? 'dark':'light'); });

    const modalCarta = document.getElementById('modalCarta');
    const iframeCarta = document.getElementById('iframeCarta');
    document.getElementById('btnCloseCarta').addEventListener('click', ()=>{ modalCarta.classList.remove('show'); iframeCarta.removeAttribute('src'); });
    function openCarta(url, title='Carta'){
      try{
        if(!url){ toast('No hay carta disponible','danger'); return; }
        document.getElementById('modalCartaTitle').textContent = title;
        iframeCarta.removeAttribute('src');
        setTimeout(()=>{ iframeCarta.src = url; }, 10);
        modalCarta.classList.add('show');
      }catch(err){ console.error(err); toast('Error al abrir la carta','danger'); }
    }
    modalCarta.addEventListener('click', (e)=>{ if(e.target===modalCarta){ modalCarta.classList.remove('show'); iframeCarta.removeAttribute('src'); } });

    const FACULTADES={'Ingeniería':['Ingeniería de Sistemas','Industrial','Civil'],'Salud':['Enfermería','Fisioterapia'],'Económicas':['Administración','Contaduría']};
    const HORAS=['Mañana','Tarde','Noche']; const MODALIDADES=['Escenario','Autónoma'];
    const TIPOS = {
      'Autónoma': ['Investigativa','Practica de Emprendimiento, Transferencia e Innovacion','Practica de creacion'],
      'Escenario': ['Escenario interno','Contrato de aprendizaje SENA','Practicas por Resolucion','Convenio de cooperacion voluntariado','Practicante trabajador','Pasantia remunerada','Convenio Docencia Servicio']
    };

    function rand(a){return a[Math.floor(Math.random()*a.length)]} function rint(a,b){return Math.floor(Math.random()*(b-a+1))+a} function id(n){return n.toString().padStart(4,'0')}
    const ESTUDIANTES = Array.from({length:80},(_,i)=>{ const fac=rand(Object.keys(FACULTADES)); const prog=rand(FACULTADES[fac]); const modPref=rand(MODALIDADES); return {id:'E-'+id(i+1), doc:(10000000+i+1).toString(), nombre:'Estudiante '+(i+1), facultad:fac, programa:prog, modalidadPreferida:modPref, horarioPreferido:rand(HORAS), estado:'Sin práctica'}; });
    const OFERTAS = Array.from({length:40},(_,i)=>{ const fac=rand(Object.keys(FACULTADES)); const prog=rand(FACULTADES[fac]); const cupos=rint(1,4), asignados=rint(0,cupos-1); return {id:'O-'+id(i+1), empresa:'Empresa '+(i+1), dependencia:['Operaciones','TI','Talento','Finanzas'][i%4], tutor:['Laura','Carlos','Marta','Andrés'][i%4], correo:'tutor'+i+'@empresa.com', telefono:'30000000'+(i%10), modalidad:['Presencial','Mixta','Remota'][i%3], horario:rand(HORAS), facultad:fac, programa:prog, cupos, asignados}; });

    let selected = new Map(); let selectedOffer = null; let asigHoy=0;

    function updateKPIs(){
      const pend = ESTUDIANTES.filter(e=>e.estado==='Sin práctica').length;
      const dispo = OFERTAS.filter(o=>o.cupos>o.asignados).length;
      let ptPend=0, ptAut=0, ptRec=0;
      for(const [, st] of selected){
        if(st.tipo==='Practicante trabajador'){
          if(st.aprobacion==='Autorizado') ptAut++; else if(st.aprobacion==='Rechazado') ptRec++; else ptPend++;
        }
      }
      document.getElementById('kpiPend').textContent=String(pend);
      document.getElementById('kpiOfertas').textContent=String(dispo);
      document.getElementById('kpiAsignadas').textContent=String(asigHoy);
      document.getElementById('kpiSel').textContent=String(selected.size);
      document.getElementById('kpiPTPend').textContent=String(ptPend);
      document.getElementById('kpiPTAut').textContent=String(ptAut);
      document.getElementById('kpiPTRec').textContent=String(ptRec);
    }

    function renderStudents(){
      const fac=document.getElementById('filFac').value; const prog=document.getElementById('filProg').value; const mod=document.getElementById('filModalidad').value; const q = (document.getElementById('searchEst').value||'').toLowerCase();
      const list = document.getElementById('estList'); list.innerHTML='';
      const base = ESTUDIANTES.filter(e=> e.estado==='Sin práctica' && (!fac || e.facultad===fac) && (!prog || e.programa===prog) && (!mod || e.modalidadPreferida===mod) && (e.nombre.toLowerCase().includes(q) || e.doc.includes(q)));
      document.getElementById('lblEstCount').textContent = base.length;
      base.forEach(e=>{
        const item=document.createElement('label'); item.className='list-group-item d-flex align-items-start gap-2';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.className='form-check-input me-2 mt-1'; cb.checked = selected.has(e.id);
        cb.addEventListener('change',()=>{ if(cb.checked){ if(!selected.has(e.id)) selected.set(e.id, { modalidad: e.modalidadPreferida, tipo: (TIPOS[e.modalidadPreferida]||[])[0], aprobacion:'Pendiente' }); } else { selected.delete(e.id); } updateSelectionTable(); });
        item.appendChild(cb);
        const box=document.createElement('div'); const st=selected.get(e.id); const status = st? st.aprobacion || 'Pendiente' : '—';
        const badge = status==='Autorizado' ? 'success' : status==='Rechazado' ? 'danger' : 'secondary';
        box.innerHTML = `<div class="fw-semibold">${e.nombre} ${st? `<span class="badge text-bg-${badge} status-badge">${status}</span>`:''}</div><div class="small text-body-secondary">${e.doc} • ${e.facultad}/${e.programa} • Pref.: ${e.modalidadPreferida}, ${e.horarioPreferido}</div>`;
        item.appendChild(box);
        list.appendChild(item);
      });
      updateKPIs();
    }

    document.getElementById('checkAll').addEventListener('change', (e)=>{
      const fac=document.getElementById('filFac').value; const prog=document.getElementById('filProg').value; const mod=document.getElementById('filModalidad').value; const q = (document.getElementById('searchEst').value||'').toLowerCase();
      const base = ESTUDIANTES.filter(e=> e.estado==='Sin práctica' && (!fac || e.facultad===fac) && (!prog || e.programa===prog) && (!mod || e.modalidadPreferida===mod) && (e.nombre.toLowerCase().includes(q) || e.doc.includes(q)));
      if(e.target.checked){ base.forEach(e=>{ if(!selected.has(e.id)) selected.set(e.id, { modalidad: e.modalidadPreferida, tipo: (TIPOS[e.modalidadPreferida]||[])[0], aprobacion:'Pendiente' }); }); }
      else { base.forEach(e=> selected.delete(e.id)); }
      renderStudents(); updateSelectionTable();
    });

    function renderOffers(){
      const q=(document.getElementById('searchOff').value||'').toLowerCase();
      const horario=document.getElementById('filHorario').value; const mod=document.getElementById('filMod').value;
      const base = OFERTAS.filter(o=> (o.cupos>o.asignados) && (!horario || o.horario===horario) && (!mod || o.modalidad===mod) && (`${o.empresa} ${o.dependencia} ${o.tutor}`.toLowerCase().includes(q)));
      const list=document.getElementById('offList'); list.innerHTML=''; document.getElementById('lblOffCount').textContent=base.length;
      base.forEach(o=>{
        const b=document.createElement('button'); b.className='list-group-item list-group-item-action text-start';
        b.innerHTML=`<div class="d-flex align-items-start gap-2"><i class="bi bi-building text-primary"></i>
          <div class="flex-grow-1"><div class="d-flex align-items-center gap-2 flex-wrap"><div class="fw-semibold">${o.empresa}</div><span class="badge text-bg-secondary">Cupos: ${o.cupos-o.asignados}</span></div><div class="small text-body-secondary">${o.dependencia} • Tutor: ${o.tutor} • ${o.modalidad} • ${o.horario}</div><div class="small">Programa objetivo: <b>${o.programa}</b> (${o.facultad})</div></div>
          <div><i class="bi bi-chevron-right"></i></div></div>`;
        b.addEventListener('click', ()=> openOffer(o));
        list.appendChild(b);
      });
      updateKPIs();
    }

    const side=document.getElementById('side'); document.getElementById('btnCloseSide').onclick=()=> side.classList.remove('open');
    function openOffer(o){
      selectedOffer = o;
      document.getElementById('sideTitle').textContent = 'Oferta — '+o.empresa;
      document.getElementById('sideBody').innerHTML = `<div class="mb-2"><b>Dependencia:</b> ${o.dependencia}</div><div class="mb-2"><b>Tutor:</b> ${o.tutor} — <a href="mailto:${o.correo}">${o.correo}</a> — <span class="text-body-secondary">${o.telefono}</span></div><div class="mb-2"><b>Modalidad/Horario:</b> ${o.modalidad} / ${o.horario}</div><div class="mb-2"><b>Cupos disponibles:</b> ${o.cupos-o.asignados}</div><div class="mb-2"><b>Programa objetivo:</b> ${o.programa} (${o.facultad})</div>`;
      side.classList.add('open');
      document.getElementById('btnUseOffer').onclick=()=>{ toast('Oferta seleccionada','secondary'); side.classList.remove('open'); };
    }

    function ensureCartaDemo(st, studentName){
      if(!st.cartaUrl){
        const blob = new Blob([`CARTA DE EMPLEADOR\\n\\nSe certifica que ${studentName} labora actualmente y realizará su práctica como "Practicante trabajador".\\n`], {type:'application/pdf'});
        st.cartaUrl = URL.createObjectURL(blob);
      }
      if(!st.empresa){ st.empresa = 'Empresa registrada por el estudiante'; }
      if(!st.tutor){ st.tutor = 'Tutor registrado por la empresa'; }
    }

    function rowExtras(row, selMod, selTipo, st, e){
      const extra = row.nextElementSibling; if(extra && extra.classList.contains('extra-cell')) extra.remove();
      if(selMod.value==='Escenario' && selTipo.value==='Practicante trabajador'){
        ensureCartaDemo(st, e.nombre);
        const tr=document.createElement('tr'); tr.className='extra-cell';
        const statusBadge = st.aprobacion==='Autorizado' ? 'success' : st.aprobacion==='Rechazado' ? 'danger' : 'secondary';
        tr.innerHTML = `<td colspan="3">
          <div class="row g-2 align-items-end">
            <div class="col-12"><span class="badge text-bg-${statusBadge} status-badge me-2">${st.aprobacion||'Pendiente'}</span><b>Practicante trabajador</b> — Carta ya cargada por el estudiante.</div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Empresa</label>
              <input type="text" class="form-control form-control-sm" value="${st.empresa||''}"/>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small mb-1">Tutor/Jefe inmediato</label>
              <input type="text" class="form-control form-control-sm" value="${st.tutor||''}"/>
            </div>
            <div class="col-12 d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" data-view="1"><i class="bi bi-eye"></i> Ver carta</button>
              <button class="btn btn-sm btn-outline-success" data-approve="1"><i class="bi bi-check2"></i> Autorizar</button>
              <button class="btn btn-sm btn-outline-danger" data-reject="1"><i class="bi bi-x"></i> Rechazar</button>
            </div>
          </div>
        </td>`;
        const [inpEmp, inpTutor] = tr.querySelectorAll('input');
        inpEmp.addEventListener('input', ()=> { st.empresa = inpEmp.value; updateKPIs(); });
        inpTutor.addEventListener('input', ()=> { st.tutor = inpTutor.value; updateKPIs(); });
        tr.querySelector('[data-view]').addEventListener('click', ()=>{ openCarta(st.cartaUrl, `Carta — ${e.nombre}`); });
        tr.querySelector('[data-approve]').addEventListener('click', ()=>{ 
          if(!(st.cartaUrl && (st.empresa||'').trim() && (st.tutor||'').trim())){ toast('Verifica carta, empresa y tutor antes de autorizar','danger'); return; }
          st.aprobacion='Autorizado'; toast('Autorizado','success'); renderStudents(); updateSelectionTable();
        });
        tr.querySelector('[data-reject]').addEventListener('click', ()=>{ st.aprobacion='Rechazado'; toast('Rechazado','danger'); renderStudents(); updateSelectionTable(); });
        row.after(tr);
      } else if(selMod.value==='Autónoma'){
        const tr=document.createElement('tr'); tr.className='extra-cell'; tr.innerHTML = `<td colspan="3"><div class="small">Empresa: <span class="badge text-bg-success">Tecnológico de Antioquia</span></div></td>`; row.after(tr);
      }
    }

    function updateSelectionTable(){
      const tbody=document.getElementById('selTable'); tbody.innerHTML='';
      if(selected.size===0){
        tbody.innerHTML = '<tr><td colspan="3" class="text-center small text-body-secondary">Selecciona estudiantes…</td></tr>';
        document.getElementById('btnAsignar').disabled=true;
        document.getElementById('btnActa').disabled=true;
        updateKPIs();
        return;
      }
      ESTUDIANTES.filter(e=>selected.has(e.id)).forEach(e=>{
        const row=document.createElement('tr');
        const st=selected.get(e.id);
        const td1=document.createElement('td'); const badge = st.aprobacion==='Autorizado'?'success':st.aprobacion==='Rechazado'?'danger':'secondary';
        td1.innerHTML=`<div class="fw-semibold">${e.nombre} <span class="badge text-bg-${badge} status-badge">${st.aprobacion||'Pendiente'}</span></div><div class="small text-body-secondary">${e.doc}</div>`;
        const td2=document.createElement('td');
        const selMod=document.createElement('select'); selMod.className='form-select form-select-sm'; selMod.innerHTML = MODALIDADES.map(m=>`<option ${st.modalidad===m?'selected':''}>${m}</option>`).join('');
        td2.appendChild(selMod);
        const td3=document.createElement('td');
        const selTipo=document.createElement('select'); selTipo.className='form-select form-select-sm';
        function populateTipos(mod){ selTipo.innerHTML = (TIPOS[mod]||[]).map(t=>`<option ${st.tipo===t?'selected':''}>${t}</option>`).join(''); rowExtras(row, selMod, selTipo, st, e); }
        selMod.addEventListener('change', ()=>{ st.modalidad=selMod.value; st.tipo=(TIPOS[st.modalidad]||[])[0]; st.aprobacion='Pendiente'; populateTipos(st.modalidad); updateKPIs(); });
        selTipo.addEventListener('change', ()=>{ st.tipo=selTipo.value; st.aprobacion = (st.tipo==='Practicante trabajador')? (st.aprobacion||'Pendiente') : 'Pendiente'; populateTipos(st.modalidad); updateKPIs(); });
        populateTipos(st.modalidad);
        td3.appendChild(selTipo);
        row.appendChild(td1); row.appendChild(td2); row.appendChild(td3);
        tbody.appendChild(row);
      });
      document.getElementById('btnAsignar').disabled=false;
      document.getElementById('btnActa').disabled=false;
      updateKPIs();
    }

    function wireBulkBar(){
      const bulkMod=document.getElementById('bulkMod'); const bulkTipo=document.getElementById('bulkTipo'); const btn=document.getElementById('btnApplyBulk');
      function refreshTipos(){ bulkTipo.innerHTML = (TIPOS[bulkMod.value]||[]).map(x=>`<option>${x}</option>`).join(''); }
      bulkMod.addEventListener('change', ()=>{ refreshTipos(); updateKPIs(); }); refreshTipos();
      btn.addEventListener('click', ()=>{
        if(selected.size===0){ toast('No hay estudiantes seleccionados','danger'); return; }
        const chosenType = bulkTipo.value;
        [...selected.keys()].forEach(id=>{ const st=selected.get(id); st.modalidad=bulkMod.value; st.tipo=chosenType; st.aprobacion = (st.tipo==='Practicante trabajador')? (st.aprobacion||'Pendiente'):'Pendiente'; });
        updateSelectionTable();
        toast('Modalidad/Tipo aplicados a seleccionados','success');
      });
    }

    document.getElementById('btnAsignar').addEventListener('click', ()=>{
      if(selected.size===0){ toast('Selecciona estudiantes', 'danger'); return; }
      const selEsts = ESTUDIANTES.filter(e=> selected.has(e.id));
      const escenarioNormales = selEsts.filter(e=> selected.get(e.id).modalidad==='Escenario' && selected.get(e.id).tipo!=='Practicante trabajador');
      const escenarioTrab = selEsts.filter(e=> selected.get(e.id).modalidad==='Escenario' && selected.get(e.id).tipo==='Practicante trabajador');
      const autonomas = selEsts.filter(e=> selected.get(e.id).modalidad==='Autónoma');

      if(escenarioNormales.length>0){
        if(!selectedOffer){ toast('Selecciona una oferta para Escenario (excepto Practicante trabajador).', 'danger'); return; }
        const cuposDisp = selectedOffer.cupos - selectedOffer.asignados;
        if(cuposDisp < escenarioNormales.length){ toast('Cupos insuficientes en la oferta seleccionada.', 'danger'); return; }
      }

      for(const e of escenarioTrab){
        const st = selected.get(e.id);
        if(!(st.cartaUrl && (st.empresa||'').trim() && (st.tutor||'').trim())){ toast(`Verifica carta/empresa/tutor para ${e.nombre}`, 'danger'); return; }
        if(st.aprobacion!=='Autorizado'){ toast(`Autoriza o rechaza a ${e.nombre} (actual: ${st.aprobacion||'Pendiente'})`, 'danger'); return; }
      }

      if(escenarioNormales.length>0){ selectedOffer.asignados += escenarioNormales.length; }

      [...selected.keys()].forEach(id=>{
        const e = ESTUDIANTES.find(x=>x.id===id); const st = selected.get(id); e.estado='Asignado';
        let empresa = '—';
        if(st.modalidad==='Autónoma'){ empresa = 'Tecnológico de Antioquia'; }
        else if(st.modalidad==='Escenario' && st.tipo==='Practicante trabajador'){ empresa = st.empresa; }
        else { empresa = selectedOffer? selectedOffer.empresa : '—'; }
        const li=document.createElement('li'); li.textContent = `${new Date().toLocaleString('es-CO')}: ${e.nombre} → ${empresa} [${st.modalidad} / ${st.tipo}${st.tipo==='Practicante trabajador' ? ' / '+st.aprobacion : ''}]`; document.getElementById('log').prepend(li);
      });
      asigHoy += selected.size; selected.clear(); selectedOffer=null;
      renderStudents(); renderOffers(); updateSelectionTable();
      toast('Asignaciones realizadas (demo).','success');
    });

    function wireInit(){ 
      const $fac=document.getElementById('filFac'); const $prog=document.getElementById('filProg');
      Object.keys(FACULTADES).forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; $fac.appendChild(o); });
      $fac.addEventListener('change', e=>{ const arr=FACULTADES[e.target.value]||[]; $prog.innerHTML='<option value=\"\">Todos</option>'; if(arr.length){arr.forEach(p=>{const o=document.createElement('option'); o.value=p; o.textContent=p; $prog.appendChild(o)}); $prog.disabled=false; } else { $prog.disabled=true; } renderStudents(); });
      $prog.addEventListener('change', renderStudents);
      document.getElementById('filModalidad').addEventListener('change', renderStudents);
      document.getElementById('btnSearch').addEventListener('click', renderStudents);
      document.getElementById('btnClear').addEventListener('click', ()=>{ $fac.value=''; $prog.value=''; $prog.disabled=true; document.getElementById('filModalidad').value=''; document.getElementById('searchEst').value=''; renderStudents(); });
      document.getElementById('searchEst').addEventListener('input', renderStudents);
      document.getElementById('searchOff').addEventListener('input', renderOffers);
      document.getElementById('filHorario').addEventListener('change', renderOffers);
      document.getElementById('filMod').addEventListener('change', renderOffers);
      wireBulkBar();
    }

    wireInit(); renderStudents(); renderOffers(); updateSelectionTable(); updateKPIs();
  </script>
</body>
</html>