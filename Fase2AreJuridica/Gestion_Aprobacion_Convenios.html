<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Portal Empresa – Gestión institucional de convenios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{
      --shadow-1:0 8px 24px rgba(0,0,0,.08);
      --shadow-2:0 12px 28px rgba(0,0,0,.12);
      --tag-bg: var(--bs-tertiary-bg);
    }
    body{background:var(--bs-body-bg)}
    .app-header{position:sticky;top:0;z-index:1030;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color);box-shadow:0 4px 12px rgba(0,0,0,.04)}
    .kpi-card{position:relative;border:0;box-shadow:var(--shadow-1);transition:transform .2s ease,box-shadow .2s ease}
    .kpi-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-2)}
    .kpi-card .lead{font-weight:600}
    .guide-card{background:var(--bs-tertiary-bg);border-left:4px solid var(--bs-primary);box-shadow:var(--shadow-1)}
    /* Horizontal tags bar */
    .tags-row{display:flex;gap:.75rem;align-items:center;overflow:auto;white-space:nowrap;padding:.25rem .25rem .75rem}
    .tag-chip{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;background:var(--tag-bg);border:1px solid var(--bs-border-color);border-radius:.5rem;text-decoration:none;box-shadow:var(--shadow-1)}
    .tag-chip .title{font-weight:600}
    .tag-chip .pill{margin-left:.25rem}
    .tag-chip.active{outline:2px solid var(--bs-primary)}
    .section-card{border:1px solid var(--bs-border-color);border-radius:.75rem;box-shadow:var(--shadow-1)}
    .sticky-tools{position:sticky;top:56px;z-index:10;background:var(--bs-body-bg)}
    .page{display:none}
    .page.active{display:block}
    .table-actions .btn{--bs-btn-padding-y:.25rem;--bs-btn-padding-x:.5rem}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container-fluid py-2 d-flex align-items-center gap-2">
      <i class="bi bi-buildings fs-4 text-primary"></i>
      <div>
        <h1 class="h5 mb-0">Portal Empresa</h1>
        <div class="text-body-secondary small">Convenios y Solicitudes de Practicantes</div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <button class="btn btn-sm btn-outline-secondary" id="showGuideBtn" type="button"><i class="bi bi-journal-text"></i> Guía</button>
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="darkModeSwitch"/>
          <label class="form-check-label" for="darkModeSwitch">Modo oscuro</label>
        </div>
      </div>
    </div>
  </header>

  <main class="container-fluid my-3">

    
    <!-- Guía rápida (ampliada) -->
    <div class="guide-card p-3 mb-3" id="guideCard">
      <div class="d-flex align-items-center justify-content-between">
        <div class="fw-semibold"><i class="bi bi-compass me-1"></i> Guía de uso – Gestión institucional de convenios</div>
        <button class="btn btn-sm btn-outline-secondary" id="toggleGuide"><span class="d-inline" id="guideState">Ocultar</span> guía</button>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-xl-4">
          <div class="small">
            <div class="fw-semibold mb-1"><i class="bi bi-inboxes me-1"></i>Bandeja de convenios</div>
            <ol class="mb-0 ps-3">
              <li>Busca el convenio en la lista (se muestra **todo** en una sola página).</li>
              <li>Haz clic en <i class="bi bi-eye"></i> para **seleccionarlo** y abrir <b>Documentación jurídica</b>.</li>
              <li>El convenio seleccionado queda guardado y podrás retomar donde ibas.</li>
            </ol>
          </div>
        </div>

        <div class="col-12 col-xl-4">
          <div class="small">
            <div class="fw-semibold mb-1"><i class="bi bi-file-earmark-text me-1"></i>Documentación jurídica</div>
            <ol class="mb-0 ps-3">
              <li>Usa <b>Cargar</b> para adjuntar archivos (simulado).</li>
              <li>Presiona <b>Aprobar</b> para marcar el documento como válido.</li>
              <li>Para <b>Rechazar</b>, ingresa una <u>observación obligatoria</u>. Se registra en el historial.</li>
              <li>Agrega notas en el cuadro de comentarios; quedan en el historial.</li>
            </ol>
          </div>
        </div>

        <div class="col-12 col-xl-4">
          <div class="small">
            <div class="fw-semibold mb-1"><i class="bi bi-diagram-3 me-1"></i>Flujo de aprobación</div>
            <ol class="mb-0 ps-3">
              <li>Las firmas son <b>secuenciales</b>. Solo se firma la primera pendiente.</li>
              <li>Puedes <b>Avanzar</b> o <b>Devolver</b> etapas; se registra en comentarios.</li>
              <li><b>Aprobar convenio</b> requiere <u>todos los documentos aprobados</u> y <u>todas las firmas completas</u>.</li>
              <li><b>Rechazar convenio</b> solicita motivo y cambia su estado.</li>
            </ol>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-xl-6">
          <div class="small">
            <div class="fw-semibold mb-1"><i class="bi bi-archive me-1"></i>Repositorio de Convenios</div>
            <ul class="mb-0 ps-3">
              <li>Filtra por <b>Estado, NIT, Empresa, Ciudad</b> y fechas.</li>
              <li>Las columnas incluyen: Estado, NIT, Empresa, Observaciones, Documentos (ok/total), Correo, Teléfono, Dirección, Ciudad, Inicio y Vencimiento.</li>
            </ul>
          </div>
        </div>
        <div class="col-12 col-xl-6">
          <div class="small">
            <div class="fw-semibold mb-1"><i class="bi bi-lightbulb me-1"></i>Reglas y tips</div>
            <ul class="mb-0 ps-3">
              <li>Los <b>KPIs</b> se actualizan en tiempo real con cada acción.</li>
              <li>La visibilidad de esta guía y el <b>modo oscuro</b> quedan guardados.</li>
              <li>Si documentos y firmas están listos, el sistema marca el convenio como <b>Vigente</b> automáticamente.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>


    <!-- KPIs -->
    <section class="mb-2">
      <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-xl-4">
        <div class="col">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div class="lead">Convenios</div>
                <i class="bi bi-journal-text"></i>
              </div>
              <div class="display-6" id="kpiTotal">—</div>
              <div class="text-body-secondary small">Vigentes: <span id="kpiVigentes">—</span> • Por vencer ≤60: <span id="kpiPorVencer">—</span></div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div class="lead">Aprobados</div>
                <i class="bi bi-check2-circle"></i>
              </div>
              <div class="display-6" id="kpiAprobados">—</div>
              <div class="text-body-secondary small">Documentos OK acumulados</div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div class="lead">Rechazados</div>
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="display-6" id="kpiRechazados">—</div>
              <div class="text-body-secondary small">Incluye convenios devueltos</div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <div class="lead">Docs pendientes</div>
                <i class="bi bi-folder2-open"></i>
              </div>
              <div class="display-6" id="kpiDocsPend">—</div>
              <div class="text-body-secondary small">Suma de pendientes por convenio</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tags de navegación horizontales -->
    <div class="tags-row mb-2" id="tags">
      <a class="tag-chip" data-page="bandeja" href="#bandeja">
        <i class="bi bi-inboxes"></i>
        <span class="title">Bandeja de convenios</span>
        <span class="badge text-bg-primary pill" id="countTag">0</span>
      </a>
      <a class="tag-chip" data-page="docs" href="#docs">
        <i class="bi bi-file-earmark-text"></i>
        <span class="title">Documentación jurídica</span><span class="small text-body-secondary d-none d-md-inline" id="chipDocsInfo"></span>
      </a>
      <a class="tag-chip" data-page="flujo" href="#flujo">
        <i class="bi bi-diagram-3"></i>
        <span class="title">Flujo de Aprobación</span><span class="small text-body-secondary d-none d-md-inline" id="chipFlujoInfo"></span>
      </a>
      <a class="tag-chip" data-page="repo" href="#repo">
        <i class="bi bi-archive"></i>
        <span class="title">Repositorio de Convenios</span>
      </a>
    </div>

    <!-- ===== PÁGINAS ===== -->

    <!-- Bandeja -->
    <section id="page-bandeja" class="page active">
      <div class="section-card">
        <div class="p-3 border-bottom">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-inboxes"></i><div class="fw-semibold">Bandeja de convenios (<span id="countLabel">—</span>)</div>
            <div class="ms-auto small" id="pageLabel">Página 1 de 1</div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light"><tr><th>Empresa / NIT</th><th>Programa / Vigencia</th><th>Estado</th><th>Docs OK</th><th>Firmas</th><th class="text-end">Acciones</th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Documentación jurídica -->
    <section id="page-docs" class="page">
      <div class="section-card">
        <div class="p-3 border-bottom d-flex align-items-center gap-2">
          <i class="bi bi-file-earmark-text"></i>
          <div class="fw-semibold">Documentación jurídica</div>
          <div class="ms-auto small" id="docsHeaderInfo">Selecciona un convenio en la Bandeja</div>
        </div>
        <div class="p-3 pt-2">
  <div id="docsCompanyBanner" class="alert alert-info small mb-2" style="display:none"></div>
</div>
<div class="p-3" id="docsContent">
          <div class="alert alert-warning mb-0" id="docsEmpty">Primero selecciona un convenio en la Bandeja.</div>
          <div id="docsPanel" style="display:none">
            <div class="small mb-2"><span id="docsBadgeEstado" class="badge text-bg-secondary">—</span> <span class="ms-2" id="docsVigencia">—</span></div>
            <div class="input-group input-group-sm mb-3"><input type="text" id="nuevoComentario" class="form-control" placeholder="Agregar comentario"><button class="btn btn-outline-primary" id="btnAddComment"><i class="bi bi-chat-dots"></i></button></div>
            <div class="small mb-2 fw-semibold">Historial</div>
            <div class="small mb-3" id="comentariosList"></div>

            <div class="table-responsive">
              <table class="table table-sm align-middle" id="tablaDocs2">
                <thead class="table-light"><tr><th>Documento</th><th>Archivo</th><th>Últ. carga</th><th>Estado</th><th>Obs.</th><th class="text-end">Acciones</th></tr></thead>
                <tbody id="tbodyDocs2"></tbody>
              </table>
            </div>
            <div class="small text-body-secondary">Al <b>rechazar</b> es obligatorio registrar observación. El escenario será notificado automáticamente.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Flujo de aprobación -->
    <section id="page-flujo" class="page">
      <div class="section-card">
        <div class="p-3 border-bottom d-flex align-items-center gap-2">
          <i class="bi bi-diagram-3"></i>
          <div class="fw-semibold">Flujo de Aprobación</div>
          <div class="ms-auto small" id="flujoHeaderInfo">Selecciona un convenio en la Bandeja</div>
        </div>
        <div class="p-3 pt-2">
  <div id="flujoCompanyBanner" class="alert alert-info small mb-2" style="display:none"></div>
</div>
<div class="p-3" id="flujoContent">
          <div class="alert alert-warning mb-0" id="flujoEmpty">Primero selecciona un convenio en la Bandeja.</div>
          <div id="flujoPanel" style="display:none">
            <div class="small mb-2"><span id="flujoBadgeEstado" class="badge text-bg-secondary">—</span> <span class="ms-2" id="flujoVigencia">—</span></div>
            <div id="firmasList2" class="vstack gap-2 mb-3"></div>
            <div class="d-flex align-items-center gap-2 mb-2">
              <button class="btn btn-outline-primary btn-sm" id="btnAvanzarEtapa2"><i class="bi bi-arrow-right-circle"></i> Avanzar a siguiente firma</button>
              <button class="btn btn-outline-warning btn-sm" id="btnDevolverEtapa2"><i class="bi bi-arrow-left-circle"></i> Devolver etapa</button>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-success btn-sm" id="btnAprobarConvenio2"><i class="bi bi-check2-circle"></i> Aprobar convenio</button>
              <button class="btn btn-danger btn-sm" id="btnRechazarConvenio2"><i class="bi bi-x-circle"></i> Rechazar convenio</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Repositorio -->
    <section id="page-repo" class="page">
      <div class="section-card">
        <div class="p-3 border-bottom d-flex align-items-center gap-2">
          <i class="bi bi-archive"></i><div class="fw-semibold">Repositorio de Convenios</div>
        </div>
        <div class="p-3 sticky-tools">
          <div class="row g-2">
            <div class="col-12 col-md-3">
              <label class="form-label small mb-1">Estado</label>
              <select id="f_estado" class="form-select form-select-sm">
                <option value="">Todos</option>
                <option>En trámite</option>
                <option>Vigente</option>
                <option>Por vencer</option>
                <option>Vencido</option>
                <option>Rechazado</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">NIT</label>
              <input id="f_nit" class="form-control form-control-sm" placeholder="Buscar NIT">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Empresa</label>
              <input id="f_empresa" class="form-control form-control-sm" placeholder="Nombre de empresa">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label small mb-1">Ciudad</label>
              <input id="f_ciudad" class="form-control form-control-sm" placeholder="Ciudad">
            </div>

            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Fecha inicio (desde)</label>
              <input id="f_ini" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small mb-1">Fecha vencimiento (hasta)</label>
              <input id="f_fin" type="date" class="form-control form-select-sm form-control-sm">
            </div>
            <div class="col-12 col-md-6 d-flex align-items-end justify-content-start gap-2">
              <button class="btn btn-primary btn-sm" id="btnAplicar"><i class="bi bi-search"></i> Aplicar</button>
              <button class="btn btn-outline-secondary btn-sm" id="btnLimpiar"><i class="bi bi-eraser"></i> Limpiar</button>
              <button class="btn btn-outline-success btn-sm" id="btnXLSX"><i class="bi bi-filetype-xlsx"></i> XLSX</button>
              <button class="btn btn-outline-danger btn-sm" id="btnPDF"><i class="bi bi-filetype-pdf"></i> PDF</button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0" id="repoTable">
            <thead class="table-light">
              <tr>
                <th>ESTADO</th>
                <th>NIT</th>
                <th>EMPRESA</th>
                <th>OBSERVACIONES</th>
                <th>DOCUMENTOS</th>
                <th>CORREO DEL ESCENARIO</th>
                <th>TELÉFONO</th>
                <th>DIRECCION DEL ESCENARIO</th>
                <th>CIUDAD</th>
                <th>FECHA DE INICIO</th>
                <th>FECHA DE VENCIMIENTO</th>
              </tr>
            </thead>
            <tbody id="repoTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex"><div class="toast-body" id="toastMsg">Hecho</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script>
    // ===== Utils & Toast =====
    const toastEl=document.getElementById('toast');
    const toastMsg=document.getElementById('toastMsg');
    const toast=new bootstrap.Toast(toastEl);
    const showToast=(m,variant='primary')=>{ toastEl.className='toast align-items-center text-bg-'+variant+' border-0'; toastMsg.textContent=m; toast.show(); };
    const fmt=(d)=> new Date(d).toLocaleDateString('es-CO');
    const daysTo=(dateStr)=> { const ms=new Date(dateStr)-new Date(); return Math.ceil(ms/86400000); };

    // ===== Dark mode & Guide =====
    const showGuideBtn=document.getElementById('showGuideBtn');
    const darkSwitch=document.getElementById('darkModeSwitch');
    if(localStorage.getItem('cgp.dark')==='1'){ document.documentElement.setAttribute('data-bs-theme','dark'); darkSwitch.checked=true; }
    darkSwitch.addEventListener('change', (e)=>{ localStorage.setItem('cgp.dark', e.target.checked?'1':'0'); document.documentElement.setAttribute('data-bs-theme', e.target.checked?'dark':'light'); });
    const guide=document.getElementById('guideCard');
    const toggleGuideBtn=document.getElementById('toggleGuide');
    const guideState=document.getElementById('guideState');
    const hiddenGuide = localStorage.getItem('hideGuide')==='1';
    function updateGuideUI(){
      const isHidden = guide.style.display==='none';
      if(guideState) guideState.textContent = isHidden? 'Mostrar':'Ocultar';
      if(showGuideBtn) showGuideBtn.innerHTML = (isHidden? '<i class="bi bi-eye"></i> Mostrar guía' : '<i class="bi bi-eye-slash"></i> Ocultar guía');
    }
    if(hiddenGuide){ guide.style.display='none'; } else { guide.style.display='block'; }
    updateGuideUI();
    const toggleGuide=()=>{
      const hidden = guide.style.display==='none';
      guide.style.display = hidden? 'block':'none';
      localStorage.setItem('hideGuide', hidden? '0':'1');
      updateGuideUI();
    };
    toggleGuideBtn.addEventListener('click',toggleGuide);
    showGuideBtn.addEventListener('click',toggleGuide);

    // ===== Data (seed) =====
    const KEY='cgp.convenios.v3';
    const DATA = JSON.parse(localStorage.getItem(KEY)||'{}');
    if(!DATA.convenios){
      const roles = [
        'Abogado gestión de convenios','Coordinación General de Prácticas','Coordinación de Prácticas',
        'Decanatura 1','Decanatura 2','Decanatura 3','Decanatura 4',
        'Dirección jurídica','Secretaría general','Vicerrectoría académica','Rectoría',
        'Representante legal (escenario)'
      ];
      const docsBase = ['RUT','Cámara de Comercio','ARL','Cédula Rep. Legal'];
      const ciudades = ['Medellín','Bogotá','Cali','Barranquilla','Manizales','Pereira'];
      DATA.convenios = Array.from({length:42},(_,i)=>{
        const estadoList=['En trámite','Vigente','Por vencer','Vencido','Rechazado'];
        const estado=estadoList[i%estadoList.length];
        const desde=new Date(); desde.setMonth(desde.getMonth()-6);
        const hasta=new Date(); hasta.setDate(hasta.getDate()+ (i%5===3? -10 : (10*(i%8))));
        const docs = docsBase.map(n=>({ nombre:n, archivo: null, fecha: null, estado: 'Pendiente', observacion: '' }));
        const firmas = roles.map((r,idx)=>({ rol:r, firmado: idx< (i%4===0? 2: (i%3===0? 5: 0)), fecha: idx< (i%4===0? 2: (i%3===0? 5: 0)) ? new Date().toISOString(): null }));
        const empresaNum = i+1;
        return {
          id:'CV-'+String(empresaNum).padStart(3,'0'),
          empresa:'Empresa '+empresaNum,
          nit:'90'+(2000000+i),
          programa:['Sistemas','Industrial','Administración','Contaduría'][i%4],
          desde:desde.toISOString().slice(0,10),
          hasta:hasta.toISOString().slice(0,10),
          estado,
          docs,
          firmas,
          comentarios:[{ts:new Date().toISOString(), actor:'Sistema', texto:'Trámite creado'}],
          contacto:{
            correo:`contacto${empresaNum}@empresa.com`,
            telefono:`30012345${String(empresaNum).padStart(2,'0')}`,
            direccion:`Calle ${empresaNum} # ${empresaNum+10}-${empresaNum+20}`,
            ciudad: ciudades[i%ciudades.length]
          }
        };
      });
      save();
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(DATA)); }
    function byId(id){ return DATA.convenios.find(c=>c.id===id); }

    // ===== Global state (convenio actual) =====
    let currentId = localStorage.getItem('cgp.current') || null;
    function setCurrent(id){
      currentId = id;
      localStorage.setItem('cgp.current', id || '');
      setSelectedCompanyVisuals();
    }

    // ===== Selected company visualization =====
    function setSelectedCompanyVisuals() {
      const docsChipInfo = document.getElementById('chipDocsInfo');
      const flujoChipInfo = document.getElementById('chipFlujoInfo');
      const docsBanner = document.getElementById('docsCompanyBanner');
      const flujoBanner = document.getElementById('flujoCompanyBanner');
      if (!currentId) {
        if (docsChipInfo) { docsChipInfo.textContent = ''; docsChipInfo.classList.add('d-none'); }
        if (flujoChipInfo) { flujoChipInfo.textContent = ''; flujoChipInfo.classList.add('d-none'); }
        if (docsBanner) docsBanner.style.display = 'none';
        if (flujoBanner) flujoBanner.style.display = 'none';
        return;
      }
      const c = byId(currentId);
      if (!c) return;
      const label = ` · ${c.empresa} (NIT ${c.nit})`;
      if (docsChipInfo) { docsChipInfo.textContent = label; docsChipInfo.classList.remove('d-none'); }
      if (flujoChipInfo) { flujoChipInfo.textContent = label; flujoChipInfo.classList.remove('d-none'); }
      const estadoHtml = badgeEstado(c.estado);
      if (docsBanner) {
        docsBanner.innerHTML = `Empresa seleccionada: <b>${c.empresa}</b> (NIT ${c.nit}) — Estado: ${estadoHtml}`;
        docsBanner.style.display = 'block';
      }
      if (flujoBanner) {
        flujoBanner.innerHTML = `Empresa seleccionada: <b>${c.empresa}</b> (NIT ${c.nit}) — Estado: ${estadoHtml}`;
        flujoBanner.style.display = 'block';
      }
    }


    // ===== KPIs =====
    function refreshKPIs(){
      const list=DATA.convenios;
      const k=(p)=> list.filter(p).length;
      document.getElementById('kpiTotal').textContent = list.length;
      document.getElementById('kpiAprobados').textContent = k(c=>c.estado==='Vigente' || c.estado==='Aprobado');
      document.getElementById('kpiRechazados').textContent = k(c=>c.estado==='Rechazado');
      document.getElementById('kpiVigentes').textContent = k(c=>c.estado==='Vigente');
      document.getElementById('kpiPorVencer').textContent = k(c=>daysTo(c.hasta)<=60 && daysTo(c.hasta)>=0);
      document.getElementById('kpiDocsPend').textContent = list.reduce((a,c)=> a + c.docs.filter(d=>d.estado!=='Aprobado').length, 0);
      document.getElementById('countLabel').textContent=list.length;
      document.getElementById('countTag').textContent=list.length;
    }

    // ===== Bandeja (single page) =====
    function badgeEstado(estado){
      const map={'En trámite':'secondary','Aprobado':'primary','Rechazado':'danger','Vigente':'success','Por vencer':'warning','Vencido':'dark','Cerrado':'secondary'};
      return `<span class="badge text-bg-${map[estado]||'secondary'}">${estado}</span>`;
    }
    function docsOk(c){ return c.docs.filter(d=>d.estado==='Aprobado').length; }
    function diasSemaforo(c){ const d=daysTo(c.hasta); return `<span class="badge ${d<0?'text-bg-dark':(d<=30?'text-bg-danger':(d<=60?'text-bg-warning text-dark':'text-bg-success'))}">${d}</span>`; }

    function renderTable(){
      const data=DATA.convenios;
      document.getElementById('pageLabel').textContent='Página 1 de 1';
      const tbody=document.getElementById('tbody'); tbody.innerHTML='';
      data.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><div class="fw-semibold">${c.empresa}</div><div class="small text-body-secondary">NIT ${c.nit}</div></td>
          <td><div>${c.programa||'—'}</div><div class="small text-body-secondary">${fmt(c.desde)} → ${fmt(c.hasta)} ${diasSemaforo(c)}</div></td>
          <td>${badgeEstado(c.estado)}</td>
          <td>${docsOk(c)}/${c.docs.length}</td>
          <td>${c.firmas.filter(f=>!f.firmado).length}</td>
          <td class="text-end table-actions"><button class="btn btn-outline-secondary btn-sm" data-id="${c.id}" title="Seleccionar y abrir Documentación"><i class="bi bi-eye"></i></button></td>`;
        tr.querySelector('button').addEventListener('click',()=>{ setCurrent(c.id); navigate('docs'); });
        tbody.appendChild(tr);
      });
    }

    // ===== Documentación jurídica (page) =====
    function renderDocsPage(){
      setSelectedCompanyVisuals();
      const empty = document.getElementById('docsEmpty');
      const panel = document.getElementById('docsPanel');
      const header = document.getElementById('docsHeaderInfo');
      if(!currentId){ empty.style.display='block'; panel.style.display='none'; header.textContent='Selecciona un convenio en la Bandeja'; showToast('Selecciona un convenio en la Bandeja','danger'); setSelectedCompanyVisuals(); return; }
      const c=byId(currentId); if(!c){ empty.style.display='block'; panel.style.display='none'; header.textContent='Convenio no encontrado'; return; }
      empty.style.display='none'; panel.style.display='block'; header.textContent = `${c.id} – ${c.empresa}`;
      document.getElementById('docsBadgeEstado').innerHTML = badgeEstado(c.estado);
      document.getElementById('docsVigencia').textContent = `${fmt(c.desde)} → ${fmt(c.hasta)} (${daysTo(c.hasta)} días)`;
      // comentarios
      const box=document.getElementById('comentariosList');
      box.innerHTML = c.comentarios.slice().reverse().map(cm=>`<div>• <b>${cm.actor}</b> (${fmt(cm.ts)}): ${cm.texto}</div>`).join('') || '<div class="text-secondary">Sin comentarios</div>';
      // documentos
      const tbody=document.getElementById('tbodyDocs2'); tbody.innerHTML='';
      c.docs.forEach((d,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.nombre}</td>
          <td>${d.archivo? `<a href="#" class="link-secondary">${d.archivo}</a>` : '<span class="text-secondary">Sin archivo</span>'}</td>
          <td>${d.fecha? fmt(d.fecha) : '—'}</td>
          <td>${d.estado==='Aprobado'? '<span class="badge text-bg-success">Aprobado</span>' : (d.estado==='Rechazado'? '<span class="badge text-bg-danger">Rechazado</span>' : '<span class="badge text-bg-secondary">Pendiente</span>')}</td>
          <td>${d.observacion? `<span class="text-secondary" title="${d.observacion}">…</span>` : '—'}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <label class="btn btn-outline-secondary mb-0"><i class="bi bi-upload"></i> Cargar<input type="file" hidden data-upload="${idx}"></label>
              <button class="btn btn-outline-success" data-approve="${idx}"><i class="bi bi-check2"></i></button>
              <button class="btn btn-outline-danger" data-reject="${idx}"><i class="bi bi-x"></i></button>
            </div>
          </td>`;
        tr.querySelector('[data-upload]').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; d.archivo=f.name; d.fecha=new Date().toISOString(); d.estado='Pendiente'; d.observacion=''; save(); renderDocsPage(); refreshKPIs(); showToast('Archivo cargado'); });
        tr.querySelector('[data-approve]').addEventListener('click', ()=>{ d.estado='Aprobado'; d.observacion=''; save(); renderDocsPage(); refreshKPIs(); showToast(`Documento “${d.nombre}” aprobado`,'secondary'); autoAdvanceIfReady(c); });
        tr.querySelector('[data-reject]').addEventListener('click', ()=>{ const obs=prompt('Observación (obligatoria):'); if(!obs || !obs.trim()){ showToast('Debes ingresar una observación','danger'); return; } d.estado='Rechazado'; d.observacion=obs.trim(); save(); renderDocsPage(); refreshKPIs(); showToast(`Documento “${d.nombre}” rechazado`,'secondary'); });
        tbody.appendChild(tr);
      });
      // comentario rápido
      document.getElementById('btnAddComment').onclick = ()=>{
        const t=document.getElementById('nuevoComentario').value.trim(); if(!t) return;
        c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:t}); document.getElementById('nuevoComentario').value='';
        save(); renderDocsPage(); showToast('Comentario agregado','secondary');
      };
    }

    // ===== Flujo de aprobación (page) =====
    function renderFirmasList(div,c){
      div.innerHTML='';
      c.firmas.forEach((f,idx)=>{
        const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between border rounded p-2';
        row.innerHTML=`<div class="d-flex align-items-center gap-2"><i class="bi ${f.firmado? 'bi-check2-circle text-success':'bi-circle text-secondary'}"></i><div><div class="fw-semibold">${idx+1}. ${f.rol}</div><div class="small text-body-secondary">${f.firmado? 'Firmado el '+fmt(f.fecha) : 'Pendiente'}</div></div></div><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary" data-sign="${idx}"><i class="bi bi-pen"></i></button></div>`;
        row.querySelector('[data-sign]').addEventListener('click', ()=>{
          const firstPending = c.firmas.findIndex(x=>!x.firmado);
          if(firstPending!==idx){ showToast('Debes seguir el orden de firmas','danger'); return; }
          f.firmado=true; f.fecha=new Date().toISOString(); save(); renderFlujoPage(); refreshKPIs(); showToast(`${f.rol} firmó`,'secondary'); autoAdvanceIfReady(c);
        });
        div.appendChild(row);
      });
    }
    function renderFlujoPage(){
      setSelectedCompanyVisuals();
      const empty = document.getElementById('flujoEmpty');
      const panel = document.getElementById('flujoPanel');
      const header = document.getElementById('flujoHeaderInfo');
      if(!currentId){ empty.style.display='block'; panel.style.display='none'; header.textContent='Selecciona un convenio en la Bandeja'; showToast('Selecciona un convenio en la Bandeja','danger'); setSelectedCompanyVisuals(); return; }
      const c=byId(currentId); if(!c){ empty.style.display='block'; panel.style.display='none'; header.textContent='Convenio no encontrado'; return; }
      empty.style.display='none'; panel.style.display='block'; header.textContent = `${c.id} – ${c.empresa}`;
      document.getElementById('flujoBadgeEstado').innerHTML = badgeEstado(c.estado);
      document.getElementById('flujoVigencia').textContent = `${fmt(c.desde)} → ${fmt(c.hasta)} (${daysTo(c.hasta)} días)`;
      renderFirmasList(document.getElementById('firmasList2'), c);
      // botones
      document.getElementById('btnAvanzarEtapa2').onclick = ()=>{
        const i=c.firmas.findIndex(f=>!f.firmado); if(i===-1){ showToast('No hay firmas pendientes','secondary'); return; }
        c.comentarios.push({ts:new Date().toISOString(), actor:'Sistema', texto:`Avanzado a etapa: ${c.firmas[i].rol}`}); save(); renderFlujoPage(); showToast('Avanzado a la siguiente etapa','secondary');
      };
      document.getElementById('btnDevolverEtapa2').onclick = ()=>{
        const i=c.firmas.findIndex(f=>!f.firmado); const target = i>0? i-1 : 0; c.firmas.forEach((f,idx)=>{ if(idx>=i) return; if(idx>=target) { f.firmado=false; f.fecha=null; } });
        c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:`Devolución a etapa: ${c.firmas[target].rol}`}); save(); renderFlujoPage(); showToast('Etapa devuelta','warning');
      };
      document.getElementById('btnAprobarConvenio2').onclick = ()=>{
        const docsOkAll=c.docs.every(d=>d.estado==='Aprobado'); const firmasOk=c.firmas.every(f=>f.firmado);
        if(!docsOkAll){ showToast('Faltan documentos aprobados','danger'); return; }
        if(!firmasOk){ showToast('Faltan firmas','danger'); return; }
        c.estado='Vigente'; save(); refreshKPIs(); renderFlujoPage(); renderTable(); showToast('Convenio aprobado – Vigente','success');
      };
      document.getElementById('btnRechazarConvenio2').onclick = ()=>{
        const obs=prompt('Motivo de rechazo (obligatorio):'); if(!obs || !obs.trim()){ showToast('Ingresa un motivo','danger'); return; }
        c.estado='Rechazado'; c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:'Rechazo convenio: '+obs.trim()}); save(); refreshKPIs(); renderFlujoPage(); renderTable(); showToast('Convenio rechazado','secondary');
      };
    }

    // ===== Business rules =====
    function autoAdvanceIfReady(c){
      const docsOkAll = c.docs.every(d=>d.estado==='Aprobado');
      const firmasOk = c.firmas.every(f=>f.firmado);
      if(docsOkAll && firmasOk){ c.estado='Vigente'; save(); refreshKPIs(); renderTable(); showToast('Convenio aprobado – Vigente','success'); }
    }

    // ===== Repositorio (tabla con filtros) =====
    function repoRow(c){
      const obs = c.docs.map(d=>d.observacion).filter(Boolean).join(' | ') || (c.comentarios.slice(-1)[0]?.texto || '');
      const documentos = `${c.docs.filter(d=>d.estado==='Aprobado').length}/${c.docs.length}`;
      return `<tr>
        <td>${c.estado}</td>
        <td>${c.nit}</td>
        <td>${c.empresa}</td>
        <td class="text-truncate" style="max-width:240px" title="${obs}">${obs || '—'}</td>
        <td>${documentos} <button class="btn btn-sm btn-outline-secondary ms-2" data-docsdl="${c.id}" title="Ver y descargar documentos"><i class="bi bi-download"></i></button></td>
        <td>${c.contacto.correo}</td>
        <td>${c.contacto.telefono}</td>
        <td>${c.contacto.direccion}</td>
        <td>${c.contacto.ciudad}</td>
        <td>${fmt(c.desde)}</td>
        <td>${fmt(c.hasta)}</td>
      </tr>`;
    }

    function applyRepo(){
      const estado = document.getElementById('f_estado').value;
      const nit = (document.getElementById('f_nit').value||'').toLowerCase();
      const empresa = (document.getElementById('f_empresa').value||'').toLowerCase();
      const ciudad = (document.getElementById('f_ciudad').value||'').toLowerCase();
      const ini = document.getElementById('f_ini').value;
      const fin = document.getElementById('f_fin').value;

      const tb = document.getElementById('repoTbody'); tb.innerHTML='';
      DATA.convenios.filter(c=>{
        if(estado && c.estado!==estado) return false;
        if(nit && !c.nit.toLowerCase().includes(nit)) return false;
        if(empresa && !c.empresa.toLowerCase().includes(empresa)) return false;
        if(ciudad && !c.contacto.ciudad.toLowerCase().includes(ciudad)) return false;
        if(ini && c.desde < ini) return false;
        if(fin && c.hasta > fin) return false;
        return true;
      }).forEach(c=> tb.insertAdjacentHTML('beforeend', repoRow(c)));
      // Attach download listeners
      tb.querySelectorAll('[data-docsdl]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const c = byId(btn.getAttribute('data-docsdl'));
          if(!c) return;
          renderDocsModal(c);
          const modal = new bootstrap.Modal(document.getElementById('docsModal'));
          modal.show();
        });
      });
    }

    document.getElementById('btnAplicar').addEventListener('click', applyRepo);
    document.getElementById('btnLimpiar').addEventListener('click', ()=>{
      ['f_estado','f_nit','f_empresa','f_ciudad','f_ini','f_fin'].forEach(id=> document.getElementById(id).value='');
      applyRepo();
    });
    document.getElementById('btnXLSX').addEventListener('click', ()=> showToast('Exportar a XLSX (simulado)','secondary'));
    document.getElementById('btnPDF').addEventListener('click', ()=> showToast('Exportar a PDF (simulado)','secondary'));

    
    function downloadDocsList(c){
      if(!c) return;
      const lines = [
        `Lista de documentos requeridos – ${c.empresa} (NIT ${c.nit})`,
        ``,
        `1) RUT`,
        `2) Cámara de Comercio`,
        `3) ARL`,
        `4) Documento Representante`,
        `5) Carta Intensión`
      ];
      const blob = new Blob([lines.join('\n')], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Documentos_${c.id}_${c.empresa.replaceAll(' ','_')}.txt`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
      showToast('Lista de documentos descargada','secondary');
    }


    // ===== Repo Docs Modal helpers =====
    const DOC_NAMES = ['RUT','Cámara de Comercio','ARL','Documento Representante','Carta Intensión'];

    function docFileName(docName, c){
      const base = docName.replaceAll(' ','_').replaceAll('á','a').replaceAll('é','e').replaceAll('í','i').replaceAll('ó','o').replaceAll('ú','u').replaceAll('ñ','n');
      return `${c.id}_${c.empresa.replaceAll(' ','_')}_${base}.txt`;
    }
    function docContent(docName, c){
      return [
        `Documento: ${docName}`,
        `Empresa: ${c.empresa}`,
        `NIT: ${c.nit}`,
        `Convenio: ${c.id}`,
        ``,
        `* Este es un archivo de muestra generado desde el repositorio.`
      ].join('\\n');
    }
    function renderDocsModal(c){
      const list = document.getElementById('docsList');
      const sub = document.getElementById('docsModalSub');
      list.innerHTML='';
      sub.textContent = `Empresa: ${c.empresa} (NIT ${c.nit})`;
      DOC_NAMES.forEach(name=>{
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        li.innerHTML = `<div><i class="bi bi-file-earmark-text me-2"></i><b>${name}</b></div>
                        <div class="btn-group btn-group-sm">
                          <button class="btn btn-outline-primary" data-dl="${name}"><i class="bi bi-download"></i> Descargar</button>
                        </div>`;
        li.querySelector('[data-dl]').addEventListener('click', ()=>{
          const blob = new Blob([docContent(name,c)], {type:'text/plain;charset=utf-8'});
          saveAs(blob, docFileName(name,c));
        });
        list.appendChild(li);
      });
      // Zip all
      const zipBtn = document.getElementById('btnZipAll');
      zipBtn.onclick = async ()=>{
        const zip = new JSZip();
        DOC_NAMES.forEach(name=>{
          zip.file(docFileName(name,c), docContent(name,c));
        });
        const blob = await zip.generateAsync({type:'blob'});
        saveAs(blob, `Documentos_${c.id}_${c.empresa.replaceAll(' ','_')}.zip`);
        showToast('ZIP descargado','secondary');
      };
    }

    // ===== Router =====
    const pages = {
      bandeja: document.getElementById('page-bandeja'),
      docs: document.getElementById('page-docs'),
      flujo: document.getElementById('page-flujo'),
      repo: document.getElementById('page-repo')
    };
    function navigate(name){
      setSelectedCompanyVisuals();
      // update hash
      if(location.hash.replace('#','')!==name) location.hash = name;
      // activate chip
      document.querySelectorAll('.tag-chip').forEach(a=> a.classList.toggle('active', a.dataset.page===name));
      // show only active page
      Object.entries(pages).forEach(([k,el])=> el.classList.toggle('active', k===name));
      // render specific content
      if(name==='docs') renderDocsPage();
      if(name==='flujo') renderFlujoPage();
      if(name==='repo') applyRepo();
      if(name==='bandeja') renderTable();
    }
    window.addEventListener('hashchange', ()=>{
      const target = (location.hash||'#bandeja').replace('#','');
      navigate(target);
    });

    // ===== Init =====
    function init(){
      setSelectedCompanyVisuals();
      refreshKPIs();
      renderTable();
      applyRepo();
      const start = (location.hash||'#bandeja').replace('#','');
      navigate(start);
      // restore current if any
      if(currentId && start!=='bandeja'){ navigate('docs'); }
    }
    init();
  </script>

  <!-- Modal: Documentos del convenio -->
  <div class="modal fade" id="docsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-folder2-open me-1"></i>Documentos del convenio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small text-body-secondary" id="docsModalSub">Empresa: —</div>
          <ul class="list-group" id="docsList">
            <!-- Filled dynamically -->
          </ul>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-success" id="btnZipAll"><i class="bi bi-archive"></i> Descargar todo (.zip)</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
