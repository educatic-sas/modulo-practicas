<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gestión de Convenios – Revisión Jurídica (Mockup v2.1)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    :root{ --shadow-1:0 8px 24px rgba(0,0,0,.08); --shadow-2:0 12px 28px rgba(0,0,0,.12); --panel-w: 560px }
    body{background:var(--bs-body-bg)}
    .app-header{position:sticky;top:0;z-index:1030;background:var(--bs-body-bg);border-bottom:1px solid var(--bs-border-color);box-shadow:0 4px 12px rgba(0,0,0,.04)}
    .kpi-card{position:relative;border:0;box-shadow:var(--shadow-1);transition:transform .2s ease,box-shadow .2s ease}
    .kpi-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-2)}
    .kpi-card::before{content:"";position:absolute;inset:0 auto 0 0;width:6px;border-radius:6px 0 0 6px;background:var(--bs-primary)}
    .sidepanel{position:fixed;top:0;right:calc(-1 * var(--panel-w));width:var(--panel-w);max-width:100vw;height:100vh;background:var(--bs-body-bg);box-shadow:-8px 0 24px rgba(0,0,0,.08);transition:right .3s ease;z-index:1055}
    .sidepanel.open{right:0}
    .sidepanel-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--bs-border-color)}
    .sidepanel-body{padding:1rem;overflow:auto;height:calc(100vh - 56px)}
    .section-title{font-weight:700;font-size:.95rem;text-transform:uppercase;letter-spacing:.02em;color:var(--bs-secondary-color)}
    .tag{display:inline-block;padding:.25rem .5rem;border-radius:4px;font-size:.75rem;font-weight:600;text-transform:uppercase;color:var(--bs-body-bg);background-color:var(--bs-primary)}
    .comment-list{max-height:160px;overflow:auto}
    .guide-card{background:var(--bs-tertiary-bg);border-left:4px solid var(--bs-primary);box-shadow:var(--shadow-1)}
    .guide-toggle{cursor:pointer;text-decoration:underline;color:var(--bs-primary)}
    .table-actions .btn{--bs-btn-padding-y:.25rem;--bs-btn-padding-x:.5rem}
    @media (max-width:576px){ .sidepanel{width:100%} }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container-fluid py-2 d-flex align-items-center gap-2">
      <i class="bi bi-handshake fs-4 text-primary"></i>
      <div>
        <h1 class="h5 mb-0">Gestión de Convenios – Revisión Jurídica</h1>
        <div class="text-body-secondary small">Bandeja institucional • Documentación • <span class="tag">Flujo de aprobación</span> • <span class="tag">Repositorio de convenios</span></div>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <div class="form-check form-switch m-0">
          <input class="form-check-input" type="checkbox" id="darkModeSwitch"/>
          <label class="form-check-label" for="darkModeSwitch">Modo oscuro</label>
        </div>
      </div>
    </div>
  </header>

  <main class="container-fluid my-3">
    <!-- Guía de uso -->
    <div class="guide-card p-3 mb-3" id="guideCard">
      <div class="d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Guía de uso del mockup</div>
        <div class="guide-toggle" id="hideGuide">Ocultar guía</div>
      </div>
      <ul class="small mt-2 mb-0">
        <li>La <b>bandeja</b> lista 100+ convenios con estado, % documentos aprobados y firmas pendientes.</li>
        <li>Abra el <b>detalle</b> con el ícono <i class="bi bi-eye"></i> para revisar <b>Documentación jurídica</b> y el <b>Flujo de aprobación</b>.</li>
        <li>Para <b>rechazar</b> un documento se solicita <b>observación obligatoria</b>. La interfaz notifica y guarda el comentario.</li>
        <li>El <b>flujo de aprobación</b> es secuencial; puede <b>devolver etapas</b> para corrección.</li>
        <li>El <b>repositorio</b> muestra convenios firmados con búsqueda y enlace simulado a Drive.</li>
      </ul>
    </div>

    <!-- KPIs -->
    <section class="mb-3">
      <div class="row g-3 row-cols-1 row-cols-md-3 row-cols-xl-6">
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">En trámite</div><div class="display-6" id="kpiTramite">—</div></div></div></div>
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">Aprobados</div><div class="display-6" id="kpiAprobados">—</div></div></div></div>
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">Rechazados</div><div class="display-6" id="kpiRechazados">—</div></div></div></div>
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">Vigentes</div><div class="display-6" id="kpiVigentes">—</div></div></div></div>
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">Por vencer ≤60/≤30</div><div class="display-6" id="kpiPorVencer">—</div></div></div></div>
        <div class="col"><div class="card kpi-card"><div class="card-body"><div class="text-secondary small">Docs pendientes</div><div class="display-6" id="kpiDocsPend">—</div></div></div></div>
      </div>
    </section>

    <div class="row g-3">
      <!-- Bandeja -->
      <div class="col-12 col-xl-8">
        <div class="card">
          <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-inboxes"></i><div class="fw-semibold">Bandeja de convenios (<span id="countLabel">—</span>)</div><div class="ms-auto small" id="pageLabel">Página 1</div></div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Empresa / NIT</th><th>Programa / Vigencia</th><th>Estado</th><th>Docs OK</th><th>Firmas</th><th class="text-end">Acciones</th></tr></thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
          <div class="card-footer d-flex align-items-center gap-2">
            <div class="btn-group" role="group" aria-label="Paginación">
              <button class="btn btn-outline-secondary btn-sm" id="btnPrev"><i class="bi bi-chevron-left"></i></button>
              <span class="btn btn-light btn-sm disabled" id="pageLabelBottom">Página 1</span>
              <button class="btn btn-outline-secondary btn-sm" id="btnNext"><i class="bi bi-chevron-right"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- Repositorio (tag visual) -->
      <div class="col-12 col-xl-4">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center gap-2"><span class="tag">Repositorio de convenios</span></div>
          <div class="p-2">
            <input id="repoSearch" class="form-control form-control-sm mb-2" placeholder="Buscar: escenario, NIT, programa, dependencia">
            <div class="list-group small" id="repoList" style="max-height:420px;overflow:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Sidepanel Detalle -->
  <aside class="sidepanel" id="sidepanel">
    <div class="sidepanel-header"><div class="fw-semibold" id="sideTitle">Detalle del convenio</div><button class="btn btn-sm btn-light" id="btnCloseSide"><i class="bi bi-x"></i></button></div>
    <div class="sidepanel-body">
      <div class="section-title mb-2">Estado del convenio</div>
      <div class="d-flex align-items-center gap-2 mb-2">
        <span id="badgeEstado" class="badge text-bg-secondary">—</span>
        <span class="small">Vigencia: <span id="vigenciaSpan">—</span></span>
        <span class="ms-auto small"><i class="bi bi-stoplights"></i> <span id="diasSpan">—</span> días</span>
      </div>
      <div class="mb-3">
        <div class="input-group input-group-sm"><input type="text" id="nuevoComentario" class="form-control" placeholder="Agregar comentario"><button class="btn btn-outline-primary" id="btnAddComment"><i class="bi bi-chat-dots"></i></button></div>
        <div class="comment-list small mt-2" id="comentariosList"></div>
      </div>

      <div class="section-title mb-2">Documentación jurídica</div>
      <div class="table-responsive mb-2">
        <table class="table table-sm align-middle" id="tablaDocs">
          <thead class="table-light"><tr><th>Documento</th><th>Archivo</th><th>Últ. carga</th><th>Estado</th><th>Obs.</th><th class="text-end">Acciones</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small text-body-secondary mb-3">Al <b>rechazar</b> es obligatorio registrar observación. El escenario será notificado automáticamente.</div>

      <div class="section-title mb-2"><span class="tag">Flujo de aprobación</span></div>
      <p class="small">Flujo secuencial; las firmas deben realizarse en orden. Se puede <b>devolver</b> a una etapa anterior para corrección.</p>
      <div id="firmasList" class="vstack gap-2 mb-3"></div>
      <div class="d-flex align-items-center gap-2 mb-2">
        <button class="btn btn-outline-primary btn-sm" id="btnAvanzarEtapa"><i class="bi bi-arrow-right-circle"></i> Avanzar a siguiente firma</button>
        <button class="btn btn-outline-warning btn-sm" id="btnDevolverEtapa"><i class="bi bi-arrow-left-circle"></i> Devolver etapa</button>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-success btn-sm" id="btnAprobarConvenio"><i class="bi bi-check2-circle"></i> Aprobar convenio</button>
        <button class="btn btn-danger btn-sm" id="btnRechazarConvenio"><i class="bi bi-x-circle"></i> Rechazar convenio</button>
      </div>
    </div>
  </aside>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast align-items-center text-bg-primary border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex"><div class="toast-body" id="toastMsg">Hecho</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== Utils & Toast =====
    const toastEl=document.getElementById('toast');
    const toastMsg=document.getElementById('toastMsg');
    const toast=new bootstrap.Toast(toastEl);
    const showToast=(m,variant='primary')=>{ toastEl.className='toast align-items-center text-bg-'+variant+' border-0'; toastMsg.textContent=m; toast.show(); };
    const fmt=(d)=> new Date(d).toLocaleDateString('es-CO');
    const daysTo=(dateStr)=> { const ms=new Date(dateStr)-new Date(); return Math.ceil(ms/86400000); };

    // ===== Dark mode & Guide =====
    const darkSwitch=document.getElementById('darkModeSwitch');
    if(localStorage.getItem('cgp.dark')==='1'){ document.documentElement.setAttribute('data-bs-theme','dark'); darkSwitch.checked=true; }
    darkSwitch.addEventListener('change', (e)=>{ localStorage.setItem('cgp.dark', e.target.checked?'1':'0'); document.documentElement.setAttribute('data-bs-theme', e.target.checked?'dark':'light'); });
    const guide=document.getElementById('guideCard');
    const hide=document.getElementById('hideGuide');
    hide.addEventListener('click',()=>{guide.style.display='none';localStorage.setItem('hideGuide','1');});
    if(localStorage.getItem('hideGuide')==='1') guide.style.display='none';

    // ===== Data (seed) =====
    const KEY='cgp.convenios.v2';
    const DATA = JSON.parse(localStorage.getItem(KEY)||'{}');
    if(!DATA.convenios){
      const roles = [
        'Abogado gestión de convenios','Coordinación General de Prácticas','Coordinación de Prácticas',
        'Decanatura 1','Decanatura 2','Decanatura 3','Decanatura 4',
        'Dirección jurídica','Secretaría general','Vicerrectoría académica','Rectoría',
        'Representante legal (escenario)'
      ];
      const docsBase = ['RUT','Cámara de Comercio','ARL','Cédula Rep. Legal'];
      DATA.convenios = Array.from({length:42},(_,i)=>{
        const estadoList=['En trámite','Vigente','Por vencer','Vencido','Rechazado'];
        const estado=estadoList[i%estadoList.length];
        const desde=new Date(); desde.setMonth(desde.getMonth()-6);
        const hasta=new Date(); hasta.setDate(hasta.getDate()+ (i%5===3? -10 : (10*(i%8))));
        const docs = docsBase.map(n=>({ nombre:n, archivo: null, fecha: null, estado: 'Pendiente', observacion: '' }));
        const firmas = roles.map((r,idx)=>({ rol:r, firmado: idx< (i%4===0? 2: (i%3===0? 5: 0)), fecha: idx< (i%4===0? 2: (i%3===0? 5: 0)) ? new Date().toISOString(): null }));
        return {
          id:'CV-'+String(i+1).padStart(3,'0'), empresa:'Empresa '+(i+1), nit:'90'+(2000000+i), programa:['Sistemas','Industrial','Administración','Contaduría'][i%4],
          desde:desde.toISOString().slice(0,10), hasta:hasta.toISOString().slice(0,10), estado,
          docs, firmas, comentarios:[{ts:new Date().toISOString(), actor:'Sistema', texto:'Trámite creado'}]
        };
      });
      save();
    }

    function save(){ localStorage.setItem(KEY, JSON.stringify(DATA)); }
    function byId(id){ return DATA.convenios.find(c=>c.id===id); }

    // ===== KPIs =====
    function refreshKPIs(){
      const list=DATA.convenios; const k=(p)=> list.filter(p).length;
      document.getElementById('kpiTramite').textContent = k(c=>c.estado==='En trámite');
      document.getElementById('kpiAprobados').textContent = k(c=>c.estado==='Vigente' || c.estado==='Aprobado');
      document.getElementById('kpiRechazados').textContent = k(c=>c.estado==='Rechazado');
      document.getElementById('kpiVigentes').textContent = k(c=>c.estado==='Vigente');
      document.getElementById('kpiPorVencer').textContent = `${k(c=>daysTo(c.hasta)<=60 && daysTo(c.hasta)>=0)}/${k(c=>daysTo(c.hasta)<=30 && daysTo(c.hasta)>=0)}`;
      document.getElementById('kpiDocsPend').textContent = list.reduce((a,c)=> a + c.docs.filter(d=>d.estado!=='Aprobado').length, 0);
    }

    // ===== Table (pagination minimal) =====
    let page=1, pageSize=15;
    function paginate(arr,p,size){ const st=(p-1)*size; return arr.slice(st,st+size); }
    function badgeEstado(estado){
      const map={'En trámite':'secondary','Aprobado':'primary','Rechazado':'danger','Vigente':'success','Por vencer':'warning','Vencido':'dark','Cerrado':'secondary'};
      return `<span class="badge text-bg-${map[estado]||'secondary'}">${estado}</span>`;
    }
    function docsOk(c){ return c.docs.filter(d=>d.estado==='Aprobado').length; }
    function diasSemaforo(c){ const d=daysTo(c.hasta); return `<span class="badge ${d<0?'text-bg-dark':(d<=30?'text-bg-danger':(d<=60?'text-bg-warning text-dark':'text-bg-success'))}">${d}</span>`; }

    function renderTable(){
      const data=DATA.convenios; const totalPages=Math.max(1,Math.ceil(data.length/pageSize)); if(page>totalPages) page=totalPages;
      const rows=paginate(data,page,pageSize); document.getElementById('countLabel').textContent=data.length;
      const label=`Página ${page} de ${totalPages}`; document.getElementById('pageLabel').textContent=label; document.getElementById('pageLabelBottom').textContent=label;
      const tbody=document.getElementById('tbody'); tbody.innerHTML='';
      rows.forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><div class="fw-semibold">${c.empresa}</div><div class="small text-body-secondary">NIT ${c.nit}</div></td>
          <td><div>${c.programa||'—'}</div><div class="small text-body-secondary">${fmt(c.desde)} → ${fmt(c.hasta)} ${diasSemaforo(c)}</div></td>
          <td>${badgeEstado(c.estado)}</td>
          <td>${docsOk(c)}/${c.docs.length}</td>
          <td>${c.firmas.filter(f=>!f.firmado).length}</td>
          <td class="text-end table-actions"><button class="btn btn-outline-secondary btn-sm" data-id="${c.id}"><i class="bi bi-eye"></i></button></td>`;
        tr.querySelector('button').addEventListener('click',()=> openSide(c.id));
        tbody.appendChild(tr);
      });
      document.getElementById('btnPrev').disabled=page<=1;
      document.getElementById('btnNext').disabled=page>=totalPages;
    }
    document.getElementById('btnPrev').addEventListener('click',()=>{ if(page>1){ page--; renderTable(); }});
    document.getElementById('btnNext').addEventListener('click',()=>{ const totalPages=Math.max(1,Math.ceil(DATA.convenios.length/pageSize)); if(page<totalPages){ page++; renderTable(); }});

    // ===== Sidepanel (detail) =====
    const side=document.getElementById('sidepanel');
    document.getElementById('btnCloseSide').addEventListener('click',()=> side.classList.remove('open'));
    let currentId=null;

    function renderComments(c){
      const box=document.getElementById('comentariosList');
      box.innerHTML = c.comentarios.slice().reverse().map(cm=>`<div>• <b>${cm.actor}</b> (${fmt(cm.ts)}): ${cm.texto}</div>`).join('') || '<div class="text-secondary">Sin comentarios</div>';
    }

    function renderDocs(c){
      const tbody=document.querySelector('#tablaDocs tbody'); tbody.innerHTML='';
      c.docs.forEach((d,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.nombre}</td>
          <td>${d.archivo? `<a href="#" class="link-secondary">${d.archivo}</a>` : '<span class="text-secondary">Sin archivo</span>'}</td>
          <td>${d.fecha? fmt(d.fecha) : '—'}</td>
          <td>${d.estado==='Aprobado'? '<span class="badge text-bg-success">Aprobado</span>' : (d.estado==='Rechazado'? '<span class="badge text-bg-danger">Rechazado</span>' : '<span class="badge text-bg-secondary">Pendiente</span>')}</td>
          <td>${d.observacion? `<span class="text-secondary" title="${d.observacion}">…</span>` : '—'}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm" role="group">
              <label class="btn btn-outline-secondary mb-0"><i class="bi bi-upload"></i> Cargar<input type="file" hidden data-upload="${idx}"></label>
              <button class="btn btn-outline-success" data-approve="${idx}"><i class="bi bi-check2"></i></button>
              <button class="btn btn-outline-danger" data-reject="${idx}"><i class="bi bi-x"></i></button>
            </div>
          </td>`;
        tr.querySelector('[data-upload]').addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(!f) return; d.archivo=f.name; d.fecha=new Date().toISOString(); d.estado='Pendiente'; d.observacion=''; save(); renderDocs(c); refreshKPIs(); showToast('Archivo cargado'); });
        tr.querySelector('[data-approve]').addEventListener('click', ()=>{ d.estado='Aprobado'; d.observacion=''; save(); renderDocs(c); refreshKPIs(); showToast(`Documento “${d.nombre}” aprobado`,'secondary'); autoAdvanceIfReady(c); });
        tr.querySelector('[data-reject]').addEventListener('click', ()=>{ const obs=prompt('Observación (obligatoria):'); if(!obs || !obs.trim()){ showToast('Debes ingresar una observación','danger'); return; } d.estado='Rechazado'; d.observacion=obs.trim(); save(); renderDocs(c); refreshKPIs(); showToast(`Documento “${d.nombre}” rechazado`,'secondary'); });
        tbody.appendChild(tr);
      });
    }

    function renderFirmas(c){
      const div=document.getElementById('firmasList'); div.innerHTML='';
      c.firmas.forEach((f,idx)=>{
        const row=document.createElement('div'); row.className='d-flex align-items-center justify-content-between border rounded p-2';
        row.innerHTML=`<div class="d-flex align-items-center gap-2"><i class="bi ${f.firmado? 'bi-check2-circle text-success':'bi-circle text-secondary'}"></i><div><div class="fw-semibold">${idx+1}. ${f.rol}</div><div class="small text-body-secondary">${f.firmado? 'Firmado el '+fmt(f.fecha) : 'Pendiente'}</div></div></div><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary" data-sign="${idx}"><i class="bi bi-pen"></i></button></div>`;
        row.querySelector('[data-sign]').addEventListener('click', ()=>{
          // Solo permite firmar el primer rol pendiente (flujo secuencial)
          const firstPending = c.firmas.findIndex(x=>!x.firmado);
          if(firstPending!==idx){ showToast('Debes seguir el orden de firmas','danger'); return; }
          f.firmado=true; f.fecha=new Date().toISOString(); save(); renderFirmas(c); refreshKPIs(); showToast(`${f.rol} firmó`,'secondary'); autoAdvanceIfReady(c);
        });
        div.appendChild(row);
      });
    }

    function openSide(id){
      const c=byId(id); if(!c) return; currentId=id;
      document.getElementById('sideTitle').textContent = `${c.id} – ${c.empresa}`;
      document.getElementById('badgeEstado').outerHTML = badgeEstado(c.estado);
      document.getElementById('vigenciaSpan').textContent = `${fmt(c.desde)} → ${fmt(c.hasta)}`;
      document.getElementById('diasSpan').textContent = daysTo(c.hasta);
      renderComments(c); renderDocs(c); renderFirmas(c);
      side.classList.add('open');
    }

    // ===== Business rules =====
    function autoAdvanceIfReady(c){
      const docsOkAll = c.docs.every(d=>d.estado==='Aprobado');
      const firmasOk = c.firmas.every(f=>f.firmado);
      if(docsOkAll && firmasOk){ c.estado='Vigente'; save(); refreshKPIs(); renderTable(); showToast('Convenio aprobado – Vigente','success'); }
    }

    document.getElementById('btnAddComment').addEventListener('click', ()=>{ const c=byId(currentId); if(!c) return; const t=document.getElementById('nuevoComentario').value.trim(); if(!t) return; c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:t}); document.getElementById('nuevoComentario').value=''; save(); renderComments(c); showToast('Comentario agregado','secondary'); });
    document.getElementById('btnAprobarConvenio').addEventListener('click', ()=>{ const c=byId(currentId); if(!c) return; const docsOkAll=c.docs.every(d=>d.estado==='Aprobado'); const firmasOk=c.firmas.every(f=>f.firmado); if(!docsOkAll){ showToast('Faltan documentos aprobados','danger'); return; } if(!firmasOk){ showToast('Faltan firmas','danger'); return; } c.estado='Vigente'; save(); refreshKPIs(); renderTable(); openSide(c.id); showToast('Convenio aprobado – Vigente','success'); });
    document.getElementById('btnRechazarConvenio').addEventListener('click', ()=>{ const c=byId(currentId); if(!c) return; const obs=prompt('Motivo de rechazo (obligatorio):'); if(!obs || !obs.trim()){ showToast('Ingresa un motivo','danger'); return; } c.estado='Rechazado'; c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:'Rechazo convenio: '+obs.trim()}); save(); refreshKPIs(); renderTable(); openSide(c.id); showToast('Convenio rechazado','secondary'); });

    document.getElementById('btnAvanzarEtapa').addEventListener('click', ()=>{ const c=byId(currentId); if(!c) return; const i=c.firmas.findIndex(f=>!f.firmado); if(i===-1){ showToast('No hay firmas pendientes','secondary'); return; } c.comentarios.push({ts:new Date().toISOString(), actor:'Sistema', texto:`Avanzado a etapa: ${c.firmas[i].rol}`}); save(); renderComments(c); showToast('Avanzado a la siguiente etapa','secondary'); });
    document.getElementById('btnDevolverEtapa').addEventListener('click', ()=>{ const c=byId(currentId); if(!c) return; const i=c.firmas.findIndex(f=>!f.firmado); const target = i>0? i-1 : 0; c.firmas.forEach((f,idx)=>{ if(idx>=i) return; if(idx>=target) { f.firmado=false; f.fecha=null; } }); c.comentarios.push({ts:new Date().toISOString(), actor:'Jurídica', texto:`Devolución a etapa: ${c.firmas[target].rol}`}); save(); renderFirmas(c); renderComments(c); showToast('Etapa devuelta','warning'); });

    // ===== Repository =====
    function refreshRepo(){
      const q=(document.getElementById('repoSearch').value||'').toLowerCase();
      const list = DATA.convenios.filter(c=> (c.estado==='Vigente' || c.estado==='Vencido' || c.estado==='En trámite') && (!q || c.empresa.toLowerCase().includes(q) || c.nit.includes(q) || (c.programa||'').toLowerCase().includes(q)) );
      const ul=document.getElementById('repoList'); ul.innerHTML='';
      list.forEach(c=>{ const a=document.createElement('a'); a.href='#'; a.className='list-group-item list-group-item-action d-flex align-items-center gap-2'; const url=`https://drive.google.com/file/d/${c.id}`; a.innerHTML=`<i class="bi bi-file-earmark-pdf"></i><div><div class="fw-semibold">${c.empresa} <span class="small text-body-secondary">(${c.nit})</span></div><div class="small">${badgeEstado(c.estado)} • Vigencia ${fmt(c.desde)} → ${fmt(c.hasta)} • <a href="${url}" target="_blank">Drive</a></div></div>`; ul.appendChild(a); });
    }
    document.getElementById('repoSearch').addEventListener('input', refreshRepo);

    // ===== Init =====
    function init(){ refreshKPIs(); renderTable(); refreshRepo(); }
    init();
  </script>
</body>
</html>
